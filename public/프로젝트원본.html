<!doctype html>
<html lang="ko">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=no">
<title>VitaMind - 시니어 헬스케어</title>
<style>
  body, html {
    margin: 0;
    padding: 0;
    background-color: #F8F9FA;
    font-family: "Noto Sans KR", sans-serif;
    font-size: 28px;
    font-weight: 700;
  }
  .app {
    width: 100%;
    height: 100vh;
    display: flex;
    flex-direction: column;
    background-color: #fff;
  }

  header {
    background-color: #00796B;
    color: #fff;
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 20px 30px;
    font-size: 40px;
    font-weight: 900;
  }
  .header-title { cursor: pointer; }
  .mic-button {
    background: none; border: none; color: white;
    font-size: 50px; cursor: pointer; padding: 10px;
  }
  .mic-button.active { color: #FF5722; }

  .speech-overlay {
    position: fixed; top: 0; left: 0;
    width: 100%; height: 100%;
    background-color: rgba(0, 0, 0, 0.7);
    color: white; display: flex; justify-content: center; align-items: center;
    font-size: 36px; text-align: center; z-index: 100;
    opacity: 0; visibility: hidden;
    transition: opacity 0.3s, visibility 0.3s;
  }
  .speech-overlay.visible { opacity: 1; visibility: visible; }

  main { flex: 1; padding: 30px; overflow-y: auto; }
  section { display: none; }
  section.active { display: block; }
  h2 { font-size: 42px; }

  .home-menu {
    display: grid; grid-template-columns: 1fr 1fr; gap: 25px; margin-top: 30px;
  }
  .home-menu button {
    padding: 40px 20px; font-size: 32px; font-weight: bold;
    border: 2px solid #00796B; border-radius: 15px;
    background-color: #E0F2F1; color: #004D40; cursor: pointer;
  }

  .friend-card {
    border: 2px solid #BDBDBD; border-radius: 15px;
    padding: 25px; margin-bottom: 20px;
    background-color: #FAFAFA;
  }
  .friend-name { font-size: 34px; font-weight: 900; color: #004D40; }
  .friend-category { font-size: 26px; color: #555; }
  .friend-card button {
    font-size: 28px; padding: 10px 20px;
    border: none; background-color: #00796B; color: #fff;
    border-radius: 10px; cursor: pointer; margin-top: 10px;
  }

  .product-card {
    border: 2px solid #BDBDBD; border-radius: 15px;
    padding: 25px; margin-bottom: 20px;
    display: flex; justify-content: space-between; align-items: center;
  }
  .product-info { font-size: 30px; }
  .product-card button {
    font-size: 30px; padding: 15px 25px;
    border: none; background-color: #00796B;
    color: #fff; border-radius: 10px; cursor: pointer;
  }

  #cart { margin-top: 40px; background-color: #f1f1f1; border-radius: 15px; padding: 20px; }
  #cart-items li { font-size: 28px; padding: 8px 0; }

  nav {
    display: flex; justify-content: space-around;
    background-color: #fff; border-top: 3px solid #eee;
    padding: 20px 0;
  }
  .nav-btn {
    flex: 1; text-align: center; font-size: 32px;
    cursor: pointer; padding: 10px 0;
  }
  .nav-btn.active { color: #00796B; font-weight: 900; }
</style>
</head>
<body>
<div class="app">
  <header>
    <div class="header-title" onclick="show('home')">VitaMind</div>
    <button class="mic-button" id="micButton" onclick="toggleMic()">🎤</button>
  </header>

  <div class="speech-overlay" id="speechOverlay">
    <div id="speechStatus">음성 인식 대기 중...</div>
  </div>

  <main>
    <!-- 홈 -->
    <section id="home" class="active">
      <h2>🏠 어서오세요! 
                VitaMind입니다.!! 👥</h2>
      <p style="font-size:28px; font-weight:normal; margin-bottom:40px;">
        "친구 찾아줘", "배추 담아줘"<br>라고 말씀해보세요.
      </p>
      <div class="home-menu">
        <button onclick="show('friends')">👥<br>동네 친구</button>
        <button onclick="show('alerts')">🔔<br>복지관 소식</button>
        <button onclick="show('market')">🛒<br>장보기 도우미</button>
        <button onclick="show('call')">📞<br>전화 걸기</button>
      </div>
      <div style="margin-top:18px; text-align:center;">
        <button onclick="findNearbyFriends()" style="padding:14px 20px; font-size:28px; border-radius:12px; border:2px solid #00796B; background:#E0F2F1; cursor:pointer;">
    📍 근처 친구 찾기
       </button>
      </div>
    </section>

    

    <!-- 친구 -->
    <section id="friends">
      <h2>👥 친구 찾기</h2>
      <div id="friends-list"></div>
    </section>

    <!-- 시장 -->
    <section id="market">
      <div class="market-container">
        <div id="product-list">
          <h2>🛒 시장 물품</h2>
        </div>
        <div id="cart">
          <h3>🧺 담은 물품 (<span id="cart-count">0</span>개)</h3>
          <ul id="cart-items"></ul>
        </div>
      </div>
    </section>

    <!-- 알림 -->
    <section id="alerts">
      <h2>🔔 알림</h2>
      <ul style="font-size:28px;">
        <li>10월 22일 - 건강검진</li>
        <li>10월 25일 - 복지관 요리 교실</li>
        <li>10월 30일 - 시니어 음악회</li>
      </ul>
    </section>

    <!-- 전화 -->
    <section id="call">
      <h2>📞 전화 걸기</h2>
      <p style="font-size:30px;">"가족에게 전화해줘", "복지관 전화해줘"라고 말해보세요.</p>
    </section>
  </main>

  <nav>
    <div class="nav-btn active" data-target="home">홈</div>
    <div class="nav-btn" data-target="friends">친구</div>
    <div class="nav-btn" data-target="market">시장</div>
    <div class="nav-btn" data-target="alerts">알림</div>
    <div class="nav-btn" data-target="call">전화</div>
  </nav>
</div>

<script>
  function getCookie(name) {
    const value = `; ${document.cookie}`;
    const parts = value.split(`; ${name}=`);
    if (parts.length === 2) return parts.pop().split(";").shift();
  }
  
  // ===== 친구 데이터 =====
  const friends = [
    { name: "김영자", category: "운동", desc: "매일 아침 공원 운동을 함께해요.", phone:"01012345678" },
    { name: "박철수", category: "산책", desc: "저녁마다 동네 한 바퀴 산책합니다.", phone:"01023456789" },
    { name: "이순자", category: "요리", desc: "요리 교실 같이 가실래요?", phone:"01034567890" },
    { name: "최민호", category: "영화", desc: "주말 영화관 동행을 찾아요.", phone:"01045678901" },
    { name: "정미라", category: "음악", desc: "노래방·합창단 친구 구해요.", phone:"01056789012" }
  ];

  const marketProducts = [
    { id: 1, name: '배추', price: 2000 },
    { id: 2, name: '감자', price: 1500 },
    { id: 3, name: '사과', price: 3000 },
    { id: 4, name: '돼지고기', price: 8000 },
  ];
  const cart = [];

  const navButtons = document.querySelectorAll('.nav-btn');
  navButtons.forEach(btn => {
    btn.addEventListener('click', () => show(btn.dataset.target));
  });

  function show(id) {
    document.querySelectorAll('section').forEach(s => s.classList.remove('active'));
    document.getElementById(id)?.classList.add('active');
    navButtons.forEach(b => b.classList.toggle('active', b.dataset.target === id));
  }

  function call(phone, name) {
    alert(`${name}님과 연결을 시도합니다.
    ${phone}`
    )
    window.location.href = `tel:${phone}`;
  }

  // ===== 친구 리스트 =====
  function renderFriends(list = friends) {
    const div = document.getElementById('friends-list');
    div.innerHTML = "";
    list.forEach(f => {
      const card = document.createElement('div');

      
      
      card.className = "friend-card";
      card.innerHTML = `
        <div class="friend-name">${f.name}</div>
        <div class="friend-category">💬 ${f.category} 친구</div>
        <div style="font-size:26px; margin-top:8px;">${f.desc}</div>
        <button onclick="call('${f.phone}', '${f.name}')">연락하기</button>
      `;
      
      div.appendChild(card);
    });
  }

  // ===== 시장 =====
  function renderProducts() {
    const productListDiv = document.getElementById('product-list');
    const h2 = productListDiv.querySelector('h2');
    productListDiv.innerHTML = '';
    productListDiv.appendChild(h2);
    marketProducts.forEach(product => {
      const card = document.createElement('div');
      card.className = 'product-card';
      card.innerHTML = `
        <span class="product-info">${product.name} - ${product.price.toLocaleString()}원</span>
        <button onclick="addToCart(${product.id})">담기</button>
      `;
      productListDiv.appendChild(card);
    });
  }
  function addToCart(id) {
    const product = marketProducts.find(p => p.id === id);
    if (product) {
      cart.push(product);
      renderCart();
      alert(`${product.name}을(를) 장바구니에 담았습니다.`);
    }
  }
  function renderCart() {
    const list = document.getElementById('cart-items');
    const count = document.getElementById('cart-count');
    list.innerHTML = '';
    cart.forEach(item => {
      const li = document.createElement('li');
      li.textContent = `${item.name} (${item.price.toLocaleString()}원)`;
      list.appendChild(li);
    });
    count.textContent = cart.length;
  }

  // ===== 음성 인식 =====
  let recognizing = false;
  let recognition;
  const micBtn = document.getElementById('micButton');
  const speechOverlay = document.getElementById('speechOverlay');
  const speechStatus = document.getElementById('speechStatus');

  if ('webkitSpeechRecognition' in window) {
    recognition = new webkitSpeechRecognition();
    recognition.lang = "ko-KR";
    recognition.continuous = false;
    recognition.interimResults = false;

    recognition.onstart = () => {
      recognizing = true;
      micBtn.classList.add("active");
      speechStatus.textContent = "듣고 있어요...";
      speechOverlay.classList.add("visible");
    };

    recognition.onresult = event => {
      const text = event.results[0][0].transcript.trim();
      speechStatus.textContent = `"${text}"`;
      handleVoiceCommand(text);
    };

    recognition.onend = () => {
      recognizing = false;
      micBtn.classList.remove("active");
      setTimeout(() => speechOverlay.classList.remove("visible"), 1500);
    };
  } else {
    alert("이 브라우저는 음성인식을 지원하지 않습니다.");
    micBtn.style.display = "none";
  }

  function toggleMic() {
    if (!recognition) return;
    if (recognizing) recognition.stop();
    else recognition.start();
  }

  // ===== 음성 명령 처리 =====
  function handleVoiceCommand(text) {
    if (text.includes("친구") && (text.includes("찾아") || text.includes("찾아줘") || text.includes("근처"))) {
      // "친구 찾아줘", "근처 친구" 등일 경우 근처 찾기 실행
      findNearbyFriends();
      return;
    }

    if (text.includes("친구")) {
      show("friends");
      renderFriends();
    } 
    else if (["운동","산책","요리","영화","음악"].some(c => text.includes(c))) {
      show("friends");
      const category = ["운동","산책","요리","영화","음악"].find(c => text.includes(c));
      renderFriends(friends.filter(f => f.category === category));
      speechStatus.textContent = `${category} 친구를 보여드릴게요.`;
    }
    else if (text.includes("시장") || text.includes("장보기")) show("market");
    else if (text.includes("알림")) show("alerts");
    else if (text.includes("전화")) show("call");
    else if (text.includes("홈")) show("home");
    else {
      const product = marketProducts.find(p => text.includes(p.name));
      if (product && (text.includes("담아줘") || text.includes("추가"))) {
        show("market");
        addToCart(product.id);
        speechStatus.textContent = `"${product.name}"을(를) 담았어요.`;
      } else {
        speechStatus.textContent = "명령을 이해하지 못했어요.";
      }
    }
  }

  // ===== 근처 친구 찾기 (위치 -> 서버 호출) =====
async function findNearbyFriends() {
  const userId = getCookie("userId");
  if (!userId) {
    alert("로그인 정보가 없습니다. 다시 로그인해주세요.");
    return;
  }

  if (!navigator.geolocation) {
    alert("이 브라우저는 위치 서비스를 지원하지 않습니다.");
    return;
  }

  navigator.geolocation.getCurrentPosition(async (pos) => {
    const { latitude, longitude } = pos.coords;

    // 위치 업데이트 (세션 기반 API 사용하므로 id 보내지 않아도 됨)
    await fetch("/db/updateLocation", {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      credentials: "include",
      body: JSON.stringify({ latitude, longitude }),
    });

    // 근처 친구 검색
    const res = await fetch("/db/nearby", {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      credentials: "include",
      body: JSON.stringify({ latitude, longitude }),
    });

    if (!res.ok) {
      console.error("근처 친구 API 오류:", await res.text());
      alert("근처 친구 조회에 실패했습니다.");
      return;
    }

    const result = await res.json();
    if (!result.success) {
      alert("오류: " + result.message);
      return;
    }

    const nearbyFriends = result.data;
    console.log("근처 친구:", nearbyFriends);

    const div = document.getElementById("friends-list");
    div.innerHTML = "";
    if (nearbyFriends.length === 0) {
      div.innerHTML = `<p style="font-size:26px;">반경 5km 내 친구가 없습니다.</p>`;
      return;
    }

    nearbyFriends.forEach((f) => {
      const card = document.createElement("div");
      card.className = "friend-card";
      card.innerHTML = `
        <div class="friend-name">${f.name || f.id}</div>
        <div style="font-size:26px;">거리: ${Number(f.distance).toFixed(2)} km</div>
      `;
      div.appendChild(card);
    });

    show("friends");
  });
}

  document.addEventListener("DOMContentLoaded", () => {
    show("home");
    renderFriends();
    renderProducts();
    renderCart();
  });

</script>
</body>
</html>