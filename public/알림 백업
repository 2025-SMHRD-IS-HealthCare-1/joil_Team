<!DOCTYPE html>
<html lang="ko">
<head>
  <!-- fonts & common -->
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>ì‹œë‹ˆì–´ ì¼ì • ê³µìœ </title>

  <!-- tailwind (ui ë¹ ë¥´ê²Œ) -->
  <script src="https://cdn.tailwindcss.com"></script>

  <!-- firebase sdk -->
  <script src="https://www.gstatic.com/firebasejs/10.12.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.0/firebase-firestore-compat.js"></script>

  <style>
    /* í˜ì´ì§€ ê¸°ë³¸ */
    body { background:#f4f6fb; font-family: system-ui, -apple-system, "Noto Sans KR", sans-serif; }
    .card { background:#fff; border-radius:1.25rem; box-shadow:0 8px 24px rgba(0,0,0,.08); }
    .btn { font-weight:800; font-size:1.25rem; padding:1rem 1.25rem; border-radius:.9rem; }
    /* ë‹¬ë ¥ ì…€ */
    .cal-cell { min-height:88px; border:1px solid #e5e7eb; border-radius:.75rem; padding:.5rem; }
    .cal-today { background:#dcfce7; }        /* ì˜¤ëŠ˜ ë°°ê²½ */
    .event-line { font-size:.95rem; margin-top:.35rem; }
    .event-past { opacity:.6; }               /* ì§€ë‚œ ì¼ì • íë¦¬ê²Œ */
    .alert-chip { border:2px solid #ff9800; color:#ff9800; padding:.15rem .45rem; border-radius:.5rem; font-size:.8rem; }
  </style>

  <script>
    /* 1) firebase ì—°ê²° */
    const firebaseConfig = {
      apiKey: "AIzaSyCRcveuTZCzVS9wSfBU4j0oUtayypqmVF8",
      authDomain: "vitamind-senior.firebaseapp.com",
      projectId: "vitamind-senior",
      storageBucket: "vitamind-senior.firebasestorage.app",
      messagingSenderId: "1051160585043",
      appId: "1:1051160585043:web:676e5f3087addf4972b7a6",
      measurementId: "G-RB8Q4GWLPS"
    };
    const app = firebase.initializeApp(firebaseConfig);
    const db = firebase.firestore();

    /* 2) ì•Œë¦¼ ê¶Œí•œ ì¤€ë¹„ (ìµœì´ˆ 1íšŒ ìš”ì²­) */
    document.addEventListener("DOMContentLoaded", async () => {
      try {
        if (window.Notification && Notification.permission === "default") {
          await Notification.requestPermission();
        }
      } catch (_) {}
    });
  </script>
</head>

<body class="min-h-screen p-4">

  <!-- ìƒë‹¨ ê³µí†µ: í”„ë¡œì íŠ¸ë¡œ ëŒì•„ê°€ê¸° -->
  <button
    onclick="window.location.href='project.html#schedule'"
    class="btn bg-gray-700 text-white fixed top-4 left-4 shadow hover:bg-gray-800">
    â† ë’¤ë¡œê°€ê¸°
  </button>

  <!-- =========================
       ë©”ì¸ ë©”ë‰´ (ì¼ì • ì¶”ê°€/ëª©ë¡/ë‹¬ë ¥ ì§„ì…)
       ========================= -->
  <section id="mainMenu" class="card max-w-3xl mx-auto mt-20 p-10 text-center space-y-8">
    <h1 class="text-5xl font-black text-indigo-800 drop-shadow">ğŸ‘´ ì‹œë‹ˆì–´ ì¼ì • ê³µìœ </h1>

    <div class="space-y-5">
      <button id="goAddEvent" class="btn w-full bg-blue-500 text-white hover:bg-blue-600">â• ì¼ì • ì¶”ê°€</button>
      <button id="goViewList" class="btn w-full bg-green-500 text-white hover:bg-green-600">ğŸ“‹ ë‚´ ì¼ì • ë³´ê¸°</button>
      <button id="goCalendar" class="btn w-full bg-indigo-600 text-white hover:bg-indigo-700">ğŸ“… ìš°ë¦¬ë“¤ì˜ ì¼ì •ìœ¼ë¡œ</button>
    </div>
  </section>

  <!-- =========================
       ì¼ì • ì¶”ê°€ í˜ì´ì§€
       ========================= -->
  <section id="addEventPage" class="card max-w-2xl mx-auto mt-10 p-8 space-y-4 hidden">
    <h2 class="text-3xl font-extrabold text-[#00796B] text-center">ğŸ—“ï¸ ìƒˆ ì¼ì • ë“±ë¡</h2>

    <label class="font-semibold">ğŸ“… ë‚ ì§œ</label>
    <input id="eventDate" type="date" class="w-full border-2 border-gray-300 rounded-xl p-4 text-xl">

    <label class="font-semibold">â° ì‹œê°„</label>
    <input id="eventTime" type="time" class="w-full border-2 border-gray-300 rounded-xl p-4 text-xl">

    <label class="font-semibold">ğŸ“Œ ì œëª©</label>
    <input id="eventTitle" type="text" placeholder="ì˜ˆ: ë³‘ì› ì§„ë£Œ" class="w-full border-2 border-gray-300 rounded-xl p-4 text-xl">

    <label class="font-semibold">ğŸ“ ì„¸ë¶€ë‚´ìš©</label>
    <textarea id="eventDetails" placeholder="ì„¸ë¶€ì‚¬í•­ ì…ë ¥â€¦" class="w-full border-2 border-gray-300 rounded-xl p-4 text-xl h-32 resize-none"></textarea>

    <label class="font-semibold">ğŸ”” ì•Œë¦¼ ì‹œê°„(ë¶„ ì „)</label>
    <select id="alertBefore" class="w-full border-2 border-gray-300 rounded-xl p-4 text-xl">
      <option value="5">5</option>
      <option value="10" selected>10</option>
      <option value="30">30</option>
      <option value="60">60</option>
    </select>

    <div class="flex flex-col gap-3 pt-3">
      <button id="addEventBtn" class="btn bg-[#00796B] text-white hover:bg-[#00695C]">âœ… ì¼ì • ë“±ë¡</button>
      <button id="backToMain1" class="btn bg-gray-500 text-white hover:bg-gray-600">ğŸ”™ ë’¤ë¡œê°€ê¸°</button>
    </div>

    <div id="messageBox" class="text-center font-bold text-xl mt-1"></div>
  </section>

  <!-- =========================
       ì¼ì • ëª©ë¡ í˜ì´ì§€
       ========================= -->
  <section id="eventListPage" class="card max-w-xl mx-auto mt-10 p-8 hidden">
    <h2 class="text-2xl font-bold text-indigo-700 text-center mb-3">ğŸ“‹ ë‚´ ì¼ì • ëª©ë¡</h2>
    <div id="eventListContainer" class="space-y-3">(ë“±ë¡ëœ ì¼ì •ì´ ì—†ìŠµë‹ˆë‹¤)</div>
    <button id="backToMain2" class="btn w-full bg-gray-500 text-white hover:bg-gray-600 mt-5">ğŸ”™ ë’¤ë¡œê°€ê¸°</button>
  </section>

  <!-- =========================
       ë‹¬ë ¥ ì„¹ì…˜ (í•­ìƒ 1ê°œë§Œ ì¡´ì¬)
       ========================= -->
  <section id="calendarSection" class="card max-w-5xl mx-auto mt-10 p-6">
    <h2 class="text-3xl font-extrabold text-indigo-700 mb-4 text-center">ğŸ“… ìš°ë¦¬ë“¤ì˜ ì¼ì •</h2>

    <!-- month header -->
    <div class="flex items-center justify-between mb-3">
      <button id="prevMonth" class="btn bg-gray-200 hover:bg-gray-300 text-gray-800">â—€ ì´ì „ ë‹¬</button>
      <h3 id="monthTitle" class="text-2xl font-black text-indigo-800"></h3>
      <button id="nextMonth" class="btn bg-gray-200 hover:bg-gray-300 text-gray-800">ë‹¤ìŒ ë‹¬ â–¶</button>
    </div>

    <!-- week header -->
    <div class="grid grid-cols-7 gap-1 font-bold text-gray-700 text-center mb-1">
      <div class="text-red-600">ì¼</div><div>ì›”</div><div>í™”</div><div>ìˆ˜</div><div>ëª©</div><div>ê¸ˆ</div><div class="text-blue-600">í† </div>
    </div>

    <!-- days grid (ì—¬ê¸°ë¡œë§Œ ë Œë”) -->
    <div id="calendarContainer" class="grid grid-cols-7 gap-1 text-sm"></div>

    <button id="backToMain3" class="btn w-full bg-gray-600 text-white hover:bg-gray-700 mt-6">ğŸ”™ í™ˆìœ¼ë¡œ</button>
  </section>

  <script>
    /* ===== ì „ì—­ (ìƒíƒœ) ===== */
    let currentUser = localStorage.getItem("currentUserName") || "ê²ŒìŠ¤íŠ¸"; // ì‘ì„±ì í‘œì‹œìš©
    let calendarUnsub = null;        // firestore êµ¬ë… í•¸ë“¤
    let calendarInited = false;      // ë‹¬ë ¥ 1íšŒ ì´ˆê¸°í™” í”Œë˜ê·¸

    /* ===== ê³µí†µ show/hide ===== */
    function showSection(id) {
      document.querySelectorAll("section").forEach(s => s.classList.add("hidden"));
      document.getElementById(id)?.classList.remove("hidden");
    }

    /* ===== ë©”ì¸ ë©”ë‰´ ë²„íŠ¼ ë°”ì¸ë”© ===== */
    document.getElementById("goAddEvent").onclick = () => {
      showSection("addEventPage");
    };

    document.getElementById("goViewList").onclick = async () => {
      showSection("eventListPage");
      await loadEventList();
    };

    document.getElementById("goCalendar").onclick = () => {
      openCalendarOnce();            // 1íšŒë§Œ ì´ˆê¸°í™”
      showSection("calendarSection");
    };

    document.getElementById("backToMain1").onclick =
    document.getElementById("backToMain2").onclick =
    document.getElementById("backToMain3").onclick = () => {
      // ë‹¬ë ¥ í˜ì´ì§€ì—ì„œ ë‚˜ê°ˆ ë•Œ ì‹¤ì‹œê°„ ë¦¬ìŠ¤ë„ˆ í•´ì œ
      if (calendarUnsub) { calendarUnsub(); calendarUnsub = null; }
      showSection("mainMenu");
    };

    /* ===== ì¼ì • ë“±ë¡ ===== */
    document.getElementById("addEventBtn").onclick = async () => {
      const title   = document.getElementById("eventTitle").value.trim();
      const date    = document.getElementById("eventDate").value;
      const time    = document.getElementById("eventTime").value;
      const details = document.getElementById("eventDetails").value.trim();
      const alertBefore = parseInt(document.getElementById("alertBefore").value || "10", 10);

      const msg = document.getElementById("messageBox");

      // í•„ìˆ˜ê°’ ì²´í¬
      if (!title || !date || !time) {
        msg.textContent = "âš ï¸ ì œëª©/ë‚ ì§œ/ì‹œê°„ì„ ëª¨ë‘ ì…ë ¥í•´ì¤˜.";
        msg.className = "text-red-600 font-bold text-center";
        return;
      }

      // firestore ì €ì¥
      await db.collection("events").add({
        owner: currentUser,
        title, date, time, details,
        created_at: new Date()
      });

      // ë¡œì»¬ ì•Œë¦¼ ê¸°ë³¸ ì„¤ì • ì €ì¥(ì„ íƒ)
      localStorage.setItem("alertBefore", String(alertBefore));

      msg.textContent = "âœ… ì¼ì • ì €ì¥ ì™„ë£Œ!";
      msg.className = "text-green-700 font-bold text-center";

      // ì…ë ¥ ì´ˆê¸°í™”
      document.getElementById("eventTitle").value = "";
      document.getElementById("eventDate").value = "";
      document.getElementById("eventTime").value = "";
      document.getElementById("eventDetails").value = "";

      // ë°”ë¡œ ë‹¬ë ¥ ë³´ê¸°ë¡œ ì´ë™
      setTimeout(() => {
        openCalendarOnce();
        showSection("calendarSection");
      }, 600);
    };

    /* ===== ì¼ì • ëª©ë¡ ===== */
    async function loadEventList() {
      const now = new Date();
      const snap = await db.collection("events").orderBy("date", "asc").get();
      const box = document.getElementById("eventListContainer");
      let html = "";

      snap.forEach(doc => {
        const e = doc.data();
        const when = new Date(`${e.date}T${e.time || "00:00"}`);
        const past = when < now;
        html += `
          <div class="border-b pb-2 ${past ? 'opacity-60' : ''}">
            <strong>${e.title}</strong> <span class="text-gray-600">(${e.date} ${e.time || ""})</span><br/>
            <span class="text-gray-500">${e.details || "(ì„¸ë¶€ ë‚´ìš© ì—†ìŒ)"}${past ? " â€¢ ì§€ë‚œ ì¼ì •" : ""}</span>
            <div class="text-xs text-gray-400 mt-1">ì‘ì„±ì: ${e.owner || "ì•Œìˆ˜ì—†ìŒ"}</div>
          </div>
        `;
      });

      box.innerHTML = html || "(ë“±ë¡ëœ ì¼ì •ì´ ì—†ìŠµë‹ˆë‹¤)";
    }

    /* =========================
       ë‹¬ë ¥: 1íšŒë§Œ ì´ˆê¸°í™” + ì›”ë³„ ì‹¤ì‹œê°„ êµ¬ë…
       ========================= */
    function openCalendarOnce() {
      if (calendarInited) return;            // ì´ë¯¸ ì´ˆê¸°í™”ë©´ íŒ¨ìŠ¤
      calendarInited = true;                 // ìµœì´ˆ 1íšŒë§Œ í†µê³¼

      // ë‚´ë¶€ ìƒíƒœ
      const z2 = n => String(n).padStart(2, "0");
      let view = new Date();                 // í˜„ì¬ ë³´ì´ëŠ” ë‹¬
      let y = view.getFullYear();
      let m = view.getMonth();               // 0~11
      let monthMap = {};                     // { day: [event, ...] }

      // dom
      const monthTitle = document.getElementById("monthTitle");
      const grid = document.getElementById("calendarContainer");

      // í™”ë©´ ê·¸ë¦¬ê¸°
      function draw() {
        // ì œëª©
        monthTitle.textContent = `${y}ë…„ ${m + 1}ì›”`;

        // grid ì´ˆê¸°í™”
        grid.innerHTML = "";

        // ì²« ìš”ì¼/ë§ˆì§€ë§‰ ë‚ ì§œ ê³„ì‚°
        const firstDow = new Date(y, m, 1).getDay();
        const lastDate = new Date(y, m + 1, 0).getDate();

        // ë¹ˆì¹¸ ì±„ìš°ê¸°
        for (let i = 0; i < firstDow; i++) grid.appendChild(emptyCell());

        // ì˜¤ëŠ˜ í‘œì‹œ ê¸°ì¤€
        const today = new Date();

        // ë‚ ì§œ ì±„ìš°ê¸°
        for (let d = 1; d <= lastDate; d++) {
          const cell = document.createElement("div");
          cell.className = "cal-cell";

          // ì˜¤ëŠ˜ ë°°ê²½
          if (
            d === today.getDate() &&
            m === today.getMonth() &&
            y === today.getFullYear()
          ) cell.classList.add("cal-today");

          // ë‚ ì§œ í—¤ë”
          const head = document.createElement("div");
          head.className = "font-bold mb-1";
          head.textContent = String(d);
          cell.appendChild(head);

          // ì´ë²¤íŠ¸ ë¼ì¸
          (monthMap[d] || []).forEach(ev => {
            const when = new Date(`${ev.date}T${ev.time || "00:00"}`);
            const past = when < today;

            const line = document.createElement("div");
            line.className = "event-line";
            if (past) line.classList.add("event-past");

            line.innerHTML = `
              <span>${ev.title}${ev.details ? " - " + ev.details : ""}${past ? " â€¢ ì§€ë‚œ ì¼ì •" : ""}</span>
              <button class="alert-chip ml-2"
               onclick="return addAlert('${escapeQuote(ev.title)}','${ev.date}','${ev.time || ""}')">ğŸ””</button>
            `;
            cell.appendChild(line);
          });

          grid.appendChild(cell);
        }
      }

      // ë¹ˆì¹¸ ì…€
      function emptyCell() {
        const d = document.createElement("div");
        d.className = "cal-cell";
        d.style.background = "#f9fafb";
        return d;
      }

      // ì›” ë¦¬ìŠ¤ë„ˆ(ì¤‘ë³µ ë°©ì§€)
      function attachListener() {
        // ì´ì „ êµ¬ë… í•´ì œ
        if (calendarUnsub) { calendarUnsub(); calendarUnsub = null; }

        const yyyy = String(y);
        const mm = z2(m + 1);
        const last = z2(new Date(y, m + 1, 0).getDate());
        const start = `${yyyy}-${mm}-01`;
        const end   = `${yyyy}-${mm}-${last}`;

        // í•´ë‹¹ ì›” ë²”ìœ„ë§Œ ì‹¤ì‹œê°„ êµ¬ë…
        calendarUnsub = db.collection("events")
          .where("date", ">=", start)
          .where("date", "<=", end)
          .orderBy("date", "asc")
          .onSnapshot(snap => {
            monthMap = {};
            snap.forEach(doc => {
              const e = { id: doc.id, ...doc.data() };
              const d = parseInt(e.date.slice(8, 10), 10);
              (monthMap[d] ||= []).push(e);
            });
            draw();
          });
      }

      // ì´ì „/ë‹¤ìŒ ë‹¬
      document.getElementById("prevMonth").onclick = () => {
        m--; if (m < 0) { m = 11; y--; }
        attachListener();
      };
      document.getElementById("nextMonth").onclick = () => {
        m++; if (m > 11) { m = 0; y++; }
        attachListener();
      };

      // ìµœì´ˆ êµ¬ë…
      attachListener();

      // ë¸Œë¼ìš°ì € ì•Œë¦¼ ë¦¬ìŠ¤ë„ˆ ì‹œì‘
      startEventAlertListener();
    }

    /* =========================
       ë¸Œë¼ìš°ì € ì•Œë¦¼ (ê°€ê¹Œìš´ ì¼ì •)
       ========================= */
    function startEventAlertListener() {
      if (!window.Notification) return;             // ë¯¸ì§€ì› ë¸Œë¼ìš°ì €
      const alertBefore = parseInt(localStorage.getItem("alertBefore") || "10", 10);

      db.collection("events").onSnapshot(snapshot => {
        const now = new Date();
        const future = new Date(now.getTime() + alertBefore * 60000);

        snapshot.forEach(doc => {
          const e = doc.data();
          if (!e.date || !e.time) return;

          const when = new Date(`${e.date}T${e.time}`);
          if (when > now && when <= future) {
            const key = `notified_${doc.id}`;
            if (localStorage.getItem(key)) return;

            localStorage.setItem(key, "true");

            // ë¸Œë¼ìš°ì € ì•Œë¦¼
            if (Notification.permission === "granted") {
              new Notification("ì¼ì • ì•Œë¦¼", {
                body: `${e.title} (${e.time}) â€¢ ${alertBefore}ë¶„ ì „`,
              });
            }
            // ì¶”ê°€ë¡œ alert íŒì—…ë„ (ë³´ì¡°)
            alert(`ğŸ”” '${e.title}' ì¼ì •ì´ ê³§ ì‹œì‘ë¼! (${e.time}, ${alertBefore}ë¶„ ì „)`);
          }
        });
      });
    }

    /* ì•Œë¦¼ ë²„íŠ¼ì—ì„œ ì‚¬ìš©í•  util */
    function addAlert(title, date, time) {
    // ì•ˆì „ ì‹¤í–‰ (ë Œë” ë„ì¤‘ ì˜¤ë¥˜ ë°©ì§€)
    try {
      // ğŸ”¹ ë¶€ëª¨ì°½(project.html)ì—ë„ ì „ë‹¬
      if (window.parent && window.parent !== window) {
        window.parent.postMessage(
          { type: "ADD_ALERT", title, date, time: time || "" },
          "*" // ê°™ì€ ë„ë©”ì¸ì´ë©´ location.originìœ¼ë¡œ ë°”ê¿”ë„ OK
        );
      }
    } catch (e) {
      console.warn("postMessage ì‹¤íŒ¨:", e);
    }

    // ğŸ”¹ ê¸°ì¡´ ì•ˆë‚´ alert (ìœ ì§€)
    const before = parseInt(localStorage.getItem("alertBefore") || "10", 10);
    alert(`'${title}' ì•Œë¦¼ì„ ì„¤ì •í–ˆì–´. ì‹œì‘ ${before}ë¶„ ì „ì— ì•Œë ¤ì¤„ê²Œ!`);

    // ğŸ”¹ ë°˜í™˜ê°’ false (ë Œë” ì¤‘ë‹¨ ë°©ì§€)
    return false;
  }

  // ì•ˆì „ìš© escapeQuote ìœ í‹¸ ìœ ì§€
  function escapeQuote(s) {
    return String(s).replace(/'/g, "\\'");
  }

  // (ì°¸ê³ ) onclick="return addAlert(...)" í˜•íƒœë©´ ìœ„ return falseê°€ ì œëŒ€ë¡œ ë¨¹ì–´.
  // ë§Œì•½ ë²„íŠ¼ì´ <button type="submit">ë¼ë©´ form submit ë°©ì§€ë¡œ ì•„ë˜ íŒ¨í„´ì„ ì¨:
  // onclick="event.preventDefault(); return addAlert(...);"
  </script>
</body>
</html>
