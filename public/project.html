<!doctype html>
<html lang="ko">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=no">
<title>VitaMind - ì‹œë‹ˆì–´ í—¬ìŠ¤ì¼€ì–´</title>
<style>
  body, html {
    margin: 0;
    padding: 0;
    background-color: #F8F9FA;
    font-family: "Noto Sans KR", sans-serif;
    font-size: 28px;
    font-weight: 700;
  }
  .app {
    width: 100%;
    height: 100vh;
    display: flex;
    flex-direction: column;
    background-color: #fff;
  }

  header {
    background-color: #00796B;
    color: #fff;
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 20px 30px;
    font-size: 40px;
    font-weight: 900;
  }
  #alarm-icon { cursor: pointer; }
  .header-title { cursor: pointer; }
  .header-icons { display: flex; align-items: center; gap: 20px; }
  .mic-button {
    background: none; border: none; color: white;
    font-size: 50px; cursor: pointer; 
  }
  .mic-button.active { color: #FF5722; }

  .logout-button {
      font-size: 30px; background: none; color: white;
      border: 3px solid white; border-radius: 15px; padding: 10px 20px;
      cursor: pointer; font-weight: bold;
  }

  .speech-overlay {
    position: fixed; top: 0; left: 0;
    width: 100%; height: 100%;
    background-color: rgba(0, 0, 0, 0.7);
    color: white; display: flex; justify-content: center; align-items: center;
    font-size: 36px; text-align: center; z-index: 100;
    opacity: 0; visibility: hidden;
    transition: opacity 0.3s, visibility 0.3s;
  }
  .speech-overlay.visible { opacity: 1; visibility: visible; }

  main { flex: 1; padding: 30px; overflow-y: auto; }
  section { display: none; }
  section.active { display: block; }
  h2 { font-size: 42px; }

  .home-menu {
    display: grid; grid-template-columns: 1fr 1fr; gap: 25px; margin-top: 30px;
  }
  .home-menu button {
    padding: 40px 20px; font-size: 32px; font-weight: bold;
    border: 2px solid #00796B; border-radius: 15px;
    background-color: #E0F2F1; color: #004D40; cursor: pointer;
  }

  .friend-card {
    border: 2px solid #BDBDBD; border-radius: 15px;
    padding: 25px; margin-bottom: 20px;
    background-color: #FAFAFA;
  }
  .friend-name { font-size: 34px; font-weight: 900; color: #004D40; }
  .friend-category { font-size: 26px; color: #555; }
  .friend-card button {
    font-size: 28px; padding: 10px 20px;
    border: none; background-color: #00796B; color: #fff;
    border-radius: 10px; cursor: pointer; margin-top: 10px;
  }

  .product-card {
    border: 2px solid #BDBDBD; border-radius: 15px;
    padding: 25px; margin-bottom: 20px;
    display: flex; justify-content: space-between; align-items: center;
  }
  .product-info { font-size: 30px; }
  .product-card button {
    font-size: 30px; padding: 15px 25px;
    border: none; background-color: #00796B;
    color: #fff; border-radius: 10px; cursor: pointer;
  }

  #cart { margin-top: 40px; background-color: #f1f1f1; border-radius: 15px; padding: 20px; }
  #cart-items li { font-size: 28px; padding: 8px 0; }

  nav {
    display: flex; justify-content: space-around;
    background-color: #fff; border-top: 3px solid #eee;
    padding: 20px 0;
  }
  .nav-btn {
    flex: 1; text-align: center; font-size: 32px;
    cursor: pointer; padding: 10px 0;
  }
  .nav-btn.active { color: #00796B; font-weight: 900; }

  /* ====== ê¸´ê¸‰ ì—°ë½ ë²„íŠ¼ ====== */
  .emergency-btn {
    background-color : #D32F2F !important; 
    color: white !important;
    border-color: #B71C1C !important;

    animation: blink 2s infinite;
  }

  @keyframes blink { 
    0% { 
      transform: scale(1);
      box-shadow: 0 0 0 0 rgba(211, 47, 47, 0.7); 
    }
    70% { 
      transform: scale(1.05); 
      box-shadow: 0 0 0 20px rgba(211, 47, 47, 0); 
    } 
    100% { 
      transform: scale(1); 
      box-shadow: 0 0 0 0 rgba(211, 47, 47, 0); 
    } 
  }

  /* ====== ë‹¬ë ¥ ìŠ¤íƒ€ì¼ ====== */
  #calendar-grid {
    display: grid;
    grid-template-columns: repeat(7, 1fr);
    gap: 8px;
    margin-top: 20px;
  }
  .calendar-day {
    border: 1px solid #ccc;
    border-radius: 10px;
    padding: 10px;
    min-height: 80px;
    font-size: 28px;
    background-color: #FAFAFA;
  }
  .calendar-day.today { background-color: #C8E6C9; }
  .calendar-day.empty { background: none; border: none; }
  .day-event { color: #00796B; font-size: 26px; margin-top: 6px; }

  /* ====== ì§€ë„ ê¸°ëŠ¥ ====== */
    #kakaoMapContainer {
      width: 100%;
      height: 400px;
    }
    </style>
  
  <!-- Kakao Maps API ë¶ˆëŸ¬ì˜¤ê¸° -->
  <script type="text/javascript" src="//dapi.kakao.com/v2/maps/sdk.js?appkey=433a059560072e066820d8b58d1e68f7"></script>
</head>
<body>
<div class="app">
  <header>
    <div id="alarm-icon">ğŸ””</div>
    <div class="header-title">VitaMind</div>
    <div class="header-icons">
      <button class="mic-button" id="micButton" onclick="toggleMic()">ğŸ¤</button>
      <button class="logout-button" onclick="logout()">ë¡œê·¸ì•„ì›ƒ</button>
    </div>
  </header>

  <div class="speech-overlay" id="speechOverlay">
    <div id="speechStatus">ìŒì„± ì¸ì‹ ëŒ€ê¸° ì¤‘...</div>
  </div>

  <main>
    <!-- í™ˆ -->
    <section id="home" class="active">
      <h2>ğŸ  ì–´ì„œì˜¤ì„¸ìš”! VitaMindì…ë‹ˆë‹¤. ğŸ‘¥</h2>
      <p style="font-size:28px; font-weight:normal; margin-bottom:40px;">
        "ì¹œêµ¬ ì°¾ì•„ì¤˜", "ë°°ì¶” ë‹´ì•„ì¤˜" ë¼ê³  ë§ì”€í•´ë³´ì„¸ìš”.
      </p>
      <div class="home-menu">
        <button onclick="show('friends')">ğŸ‘¥<br>ì¹œêµ¬</button>
        <button onclick="show('market')">ğŸ›’<br>ì¥ë³´ê¸°</button>
        <button onclick="show('map')">ğŸ—ºï¸<br>ì§€ë„</button>
        <button onclick="show('schedule')">ğŸ“…<br>ìš°ë¦¬ë“¤ì˜ ì¼ì •</button>
        <button onclick="show('emergency')" class="emergency-btn">ğŸš¨<br>ê¸´ê¸‰ ì—°ë½</button>
      </div>
      <div style="margin-top:18px; text-align:center;">
        <button onclick="findNearbyFriends()" style="padding:14px 20px; font-size:28px; border-radius:12px; border:2px solid #00796B; background:#E0F2F1; cursor:pointer;">
          ğŸ“ ê·¼ì²˜ ì¹œêµ¬ ì°¾ê¸°
        </button>
      </div>
    </section>

    <!-- ì¹œêµ¬ -->
    <section id="friends">
      <h2>ğŸ‘¥ ì¹œêµ¬ ì°¾ê¸°</h2>
      <div id="friends-list"></div>
    </section>

    <!-- ì‹œì¥ -->
    <section id="market">
      <div class="market-container">
        <div id="product-list">
          <h2>ğŸ›’ ì‹œì¥ ë¬¼í’ˆ</h2>
        </div>
        <div id="cart">
          <h3>ğŸ§º ë‹´ì€ ë¬¼í’ˆ (<span id="cart-count">0</span>ê°œ)</h3>
          <ul id="cart-items"></ul>
        </div>
      </div>
    </section>

    <!-- ì•Œë¦¼ -->
    <section id="alerts">
      <h2>ğŸ”” ì•Œë¦¼</h2>
      <ul style="font-size:28px;">
        <li>10ì›” 22ì¼ - ê±´ê°•ê²€ì§„</li>
        <li>10ì›” 25ì¼ - ë³µì§€ê´€ ìš”ë¦¬ êµì‹¤</li>
        <li>10ì›” 30ì¼ - ì‹œë‹ˆì–´ ìŒì•…íšŒ</li>
      </ul>
    </section>

    <!-- ì „í™” -->
    <section id="call">
      <h2>ğŸ“ ì „í™” ê±¸ê¸°</h2>
      <p style="font-size:30px;">"ê°€ì¡±ì—ê²Œ ì „í™”í•´ì¤˜", "ë³µì§€ê´€ ì „í™”í•´ì¤˜"ë¼ê³  ë§í•´ë³´ì„¸ìš”.</p>
    </section>

    <!-- ì¼ì • -->
    <section id="schedule">
      <h2>ğŸ“… 2025ë…„ 10ì›” ì¼ì •</h2>
      <div id="calendar-grid"></div>
    </section>

    <!-- ì§€ë„ -->
    <section id="map">
      <h1>ğŸ—ºï¸ ë‚´ ì£¼ë³€ ì§€ë„</h1>
      <div id="kakaoMapContainer" style="width:80%;height:400px;"></div>
    </section>
    

    <!-- ===== ì‘ê¸‰ ì„¹ì…˜ ì¶”ê°€ ===== -->
    <section id="emergency">
      <div class="content-pane">
        <h2>ğŸš¨ ì‘ê¸‰ ìƒí™©</h2>
        <p style="font-size:35px;">"ë„ì™€ì¤˜", "119" ë“±ì„ ë§ì”€í•˜ì„¸ìš”.</p>
        <button onclick="makeEmergencyCall('119')" class="emergency-btn"
              style="width:100%; padding: 30px; font-size: 40px; margin-top:20px;">
          ğŸ“ 119 ì¦‰ì‹œ ì—°ê²°
        </button>
        <button onclick="makeEmergencyCall('guardian')" style="width:100%; padding: 30px; font-size: 40px; margin-top:20px;">
          ğŸ‘¨â€ğŸ‘©â€ğŸ‘§ ë³´í˜¸ìì—ê²Œ ì—°ë½
        </button>
      </div>
    </section>
    
  </main>

  <nav>
    <div class="nav-btn active" data-target="home">í™ˆ</div>
    <div class="nav-btn" data-target="friends">ì¹œêµ¬</div>
    <div class="nav-btn" data-target="market">ì‹œì¥</div>
    <div class="nav-btn" data-target="map">ì§€ë„</div>
    <div class="nav-btn" data-target="schedule">ì¼ì •</div>
    <div class="nav-btn" data-target="call">ì „í™”</div>
    <div class="nav-btn" data-target="emergency">ì‘ê¸‰</div>
  </nav>
</div>

<script>

/* ==================== ë¡œê·¸ì•„ì›ƒ ==================== */
async function logout() { 
  if (confirm('ë¡œê·¸ì•„ì›ƒ í•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) { 
    try {
      // 1. ì„œë²„ì— ë¡œê·¸ì•„ì›ƒ ìš”ì²­ (ì„¸ì…˜ íŒŒê´´)
      const res = await fetch('/db/logout', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        credentials: 'include' // ì„¸ì…˜/ì¿ í‚¤ ì •ë³´ ì „ì†¡ í•„ìˆ˜
      });

      if (!res.ok) {
        throw new Error('ì„œë²„ì—ì„œ ë¡œê·¸ì•„ì›ƒ ì‹¤íŒ¨');
      }

      // 2. í´ë¼ì´ì–¸íŠ¸ ì¸¡ ë°ì´í„° ì œê±°
      localStorage.removeItem('isLoggedIn'); 
      localStorage.removeItem('loggedInUser'); 
      // loggedInUser = null; // ì‚¬ìš©ë˜ì§€ ì•ŠëŠ” ì „ì—­ ë³€ìˆ˜ ì´ˆê¸°í™” ì½”ë“œëŠ” ì œê±°í•˜ê±°ë‚˜ ì£¼ì„ ì²˜ë¦¬

      // 3. ë©”ì¸ í˜ì´ì§€ë¡œ ì´ë™
      window.location.href = 'main.html';
    } catch (err) {
      console.error("ë¡œê·¸ì•„ì›ƒ ì˜¤ë¥˜:", err);
      alert("ë¡œê·¸ì•„ì›ƒ ì²˜ë¦¬ ì¤‘ ë¬¸ì œê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤. ë‹¤ì‹œ ì‹œë„í•´ì£¼ì„¸ìš”.");
    }
  } 
}

/* ==================== ì§€ë„ ì¤‘ì‹¬ ì¢Œí‘œ (ì˜ˆ: ì„œìš¸) ==================== */
  let map = null; // ì§€ë„ ê°ì²´ë¥¼ ì €ì¥í•  ì „ì—­ ë³€ìˆ˜

Â  function initMap() {
    // kakao ê°ì²´ê°€ ì •ì˜ë˜ì§€ ì•Šì•˜ìœ¼ë©´ í•¨ìˆ˜ ì‹¤í–‰ì„ ì¤‘ë‹¨
    if (typeof kakao === 'undefined' || typeof kakao.maps === 'undefined') {
        console.error("Kakao Maps APIê°€ ì•„ì§ ë¡œë“œë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤.");
        return; 
    }
    
Â  Â  const mapContainer = document.getElementById('kakaoMapContainer');
Â  Â  const centerPos = new kakao.maps.LatLng(35.1515, 126.9091); // ê´‘ì£¼ê´‘ì—­ì‹œì²­ ì¢Œí‘œ

Â  Â  const mapOption = {
Â  Â  Â  Â  center: centerPos, 
Â  Â  Â  Â  level: 5
Â  Â  };

Â  Â  // ì§€ë„ê°€ ì´ë¯¸ ìƒì„±ë˜ì§€ ì•Šì€ ê²½ìš°ì—ë§Œ ìƒì„±
Â  Â  if (!map) {
Â  Â  Â  Â  map = new kakao.maps.Map(mapContainer, mapOption);
Â  Â  Â  Â  const marker = new kakao.maps.Marker({
Â  Â  Â  Â  Â  Â  position: centerPos
Â  Â  Â  Â  });
Â  Â  Â  Â  marker.setMap(map);
Â  Â  }
Â  }

// ===== UI í•¨ìˆ˜ (ìˆ˜ì •ë¨) =====
  function show(id) {
Â  Â  document.querySelectorAll("section").forEach(s => s.classList.remove("active"));
Â  Â  const section = document.getElementById(id);
Â  Â  if (section) {
Â  Â  Â  Â  section.classList.add("active");
Â  Â  Â  Â  
Â  Â  Â  Â  // 'ì§€ë„' ì„¹ì…˜ì´ í‘œì‹œë  ë•Œë§Œ ì§€ë„ ê´€ë ¨ ë¡œì§ ì‹¤í–‰
Â  Â  Â  Â  if (id === 'map') {
Â  Â  Â  Â  Â  Â  // kakao.maps.loadë¥¼ ì‚¬ìš©í•˜ì—¬ API ë¡œë“œê°€ ì™„ë£Œëœ í›„ ì§€ë„ ìƒì„±/ì¬ì„¤ì • ë³´ì¥
Â  Â  Â  Â  Â  Â  kakao.maps.load(function() {
Â  Â  Â  Â  Â  Â  Â  Â  if (!map) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  initMap(); // ì§€ë„ ê°ì²´ê°€ ì—†ìœ¼ë©´ ìƒì„±
Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  Â  Â  
Â  Â  Â  Â  Â  Â  Â  Â  // ì§€ë„ê°€ ì œëŒ€ë¡œ ìƒì„±ë˜ì—ˆëŠ”ì§€ í™•ì¸ í›„ í¬ê¸° ì¬ì„¤ì • ë° ì¤‘ì‹¬ ì´ë™
Â  Â  Â  Â  Â  Â  Â  Â  if (map) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  map.relayout(); // ì»¨í…Œì´ë„ˆ í¬ê¸° ë³€ê²½ ì‹œ í•„ìˆ˜
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  // ì§€ë„ê°€ ì•ˆ ë³´ì¸ë‹¤ëŠ” ê²ƒì€ ì¤‘ì‹¬ ì¢Œí‘œê°€ 0,0ì— ìˆëŠ” ê²ƒì¼ ìˆ˜ ìˆìœ¼ë¯€ë¡œ ë‹¤ì‹œ ì„¤ì •
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  map.setCenter(new kakao.maps.LatLng(35.1515, 126.9091)); 
Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  });
Â  Â  Â  Â  }
Â  Â  }
Â  Â  document.querySelectorAll(".nav-btn").forEach(b => b.classList.toggle("active", b.dataset.target === id));
Â  }

function getCookie(name) {
    const value = `; ${document.cookie}`;
    const parts = value.split(`; ${name}=`);
    if (parts.length === 2) return parts.pop().split(";").shift();
  }
  
  // ===== ì¹œêµ¬ ë°ì´í„° =====
  const friends = [
    { name: "ê¹€ì˜ì", category: "ìš´ë™", desc: "ë§¤ì¼ ì•„ì¹¨ ê³µì› ìš´ë™ì„ í•¨ê»˜í•´ìš”.", phone:"01012345678" },
    { name: "ë°•ì² ìˆ˜", category: "ì‚°ì±…", desc: "ì €ë…ë§ˆë‹¤ ë™ë„¤ í•œ ë°”í€´ ì‚°ì±…í•©ë‹ˆë‹¤.", phone:"01023456789" },
    { name: "ì´ìˆœì", category: "ìš”ë¦¬", desc: "ìš”ë¦¬ êµì‹¤ ê°™ì´ ê°€ì‹¤ë˜ìš”?", phone:"01034567890" },
    { name: "ìµœë¯¼í˜¸", category: "ì˜í™”", desc: "ì£¼ë§ ì˜í™”ê´€ ë™í–‰ì„ ì°¾ì•„ìš”.", phone:"01045678901" },
    { name: "ì •ë¯¸ë¼", category: "ìŒì•…", desc: "ë…¸ë˜ë°©Â·í•©ì°½ë‹¨ ì¹œêµ¬ êµ¬í•´ìš”.", phone:"01056789012" }
  ];

  const marketProducts = [
    { id: 1, name: 'ë°°ì¶”', price: 2000 },
    { id: 2, name: 'ê°ì', price: 1500 },
    { id: 3, name: 'ì‚¬ê³¼', price: 3000 },
    { id: 4, name: 'ë¼ì§€ê³ ê¸°', price: 8000 },
  ];
  const cart = [];

  const navButtons = document.querySelectorAll('.nav-btn');
  navButtons.forEach(btn => {
    btn.addEventListener('click', () => show(btn.dataset.target));
  });

 

  function call(phone, name) {
    alert(`${name}ë‹˜ê³¼ ì—°ê²°ì„ ì‹œë„í•©ë‹ˆë‹¤.
    ${phone}`
    )
    window.location.href = `tel:${phone}`;
  }

  // ===== ì¹œêµ¬ ë¦¬ìŠ¤íŠ¸ =====
  function renderFriends(list = friends) {
    const div = document.getElementById('friends-list');
    div.innerHTML = "";
    list.forEach(f => {
      const card = document.createElement('div');

      
      
      card.className = "friend-card";
      card.innerHTML = `
        <div class="friend-name">${f.name}</div>
        <div class="friend-category">ğŸ’¬ ${f.category} ì¹œêµ¬</div>
        <div style="font-size:26px; margin-top:8px;">${f.desc}</div>
        <button onclick="call('${f.phone}', '${f.name}')">ì—°ë½í•˜ê¸°</button>
      `;
      
      div.appendChild(card);
    });
  }

  // ===== ì‹œì¥ =====
  function renderProducts() {
    const productListDiv = document.getElementById('product-list');
    const h2 = productListDiv.querySelector('h2');
    productListDiv.innerHTML = '';
    productListDiv.appendChild(h2);
    marketProducts.forEach(product => {
      const card = document.createElement('div');
      card.className = 'product-card';
      card.innerHTML = `
        <span class="product-info">${product.name} - ${product.price.toLocaleString()}ì›</span>
        <button onclick="addToCart(${product.id})">ë‹´ê¸°</button>
      `;
      productListDiv.appendChild(card);
    });
  }
  function addToCart(id) {
    const product = marketProducts.find(p => p.id === id);
    if (product) {
      cart.push(product);
      renderCart();
      alert(`${product.name}ì„(ë¥¼) ì¥ë°”êµ¬ë‹ˆì— ë‹´ì•˜ìŠµë‹ˆë‹¤.`);
    }
  }
  function renderCart() {
    const list = document.getElementById('cart-items');
    const count = document.getElementById('cart-count');
    list.innerHTML = '';
    cart.forEach(item => {
      const li = document.createElement('li');
      li.textContent = `${item.name} (${item.price.toLocaleString()}ì›)`;
      list.appendChild(li);
    });
    count.textContent = cart.length;
  }

  // ===== ìŒì„± ì¸ì‹ =====
  let recognizing = false;
  let recognition;
  const micBtn = document.getElementById('micButton');
  const speechOverlay = document.getElementById('speechOverlay');
  const speechStatus = document.getElementById('speechStatus');

  if ('webkitSpeechRecognition' in window) {
    recognition = new webkitSpeechRecognition();
    recognition.lang = "ko-KR";
    recognition.continuous = false;
    recognition.interimResults = false;

    recognition.onstart = () => {
      recognizing = true;
      micBtn.classList.add("active");
      speechStatus.textContent = "ë“£ê³  ìˆì–´ìš”...";
      speechOverlay.classList.add("visible");
    };

    recognition.onresult = event => {
      const text = event.results[0][0].transcript.trim();
      speechStatus.textContent = `"${text}"`;
      handleVoiceCommand(text);
    };

    recognition.onend = () => {
      recognizing = false;
      micBtn.classList.remove("active");
      setTimeout(() => speechOverlay.classList.remove("visible"), 1500);
    };
  } else {
    alert("ì´ ë¸Œë¼ìš°ì €ëŠ” ìŒì„±ì¸ì‹ì„ ì§€ì›í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤.");
    micBtn.style.display = "none";
  }

  function toggleMic() {
    if (!recognition) return;
    if (recognizing) recognition.stop();
    else recognition.start();
  }

  // ===== ìŒì„± ëª…ë ¹ ì²˜ë¦¬ =====
  function handleVoiceCommand(text) {
    if (text.includes("ì¹œêµ¬") && (text.includes("ì°¾ì•„") || text.includes("ì°¾ì•„ì¤˜") || text.includes("ê·¼ì²˜"))) {
      // "ì¹œêµ¬ ì°¾ì•„ì¤˜", "ê·¼ì²˜ ì¹œêµ¬" ë“±ì¼ ê²½ìš° ê·¼ì²˜ ì°¾ê¸° ì‹¤í–‰
      findNearbyFriends();
      return;
    }

    if (text.includes("ì¹œêµ¬")) {
      show("friends");
      renderFriends();
    } 
    else if (["ìš´ë™","ì‚°ì±…","ìš”ë¦¬","ì˜í™”","ìŒì•…"].some(c => text.includes(c))) {
      show("friends");
      const category = ["ìš´ë™","ì‚°ì±…","ìš”ë¦¬","ì˜í™”","ìŒì•…"].find(c => text.includes(c));
      renderFriends(friends.filter(f => f.category === category));
      speechStatus.textContent = `${category} ì¹œêµ¬ë¥¼ ë³´ì—¬ë“œë¦´ê²Œìš”.`;
    }
    else if (text.includes("ì‹œì¥") || text.includes("ì¥ë³´ê¸°")) show("market");
    else if (text.includes("ì•Œë¦¼")) show("alerts");
    else if (text.includes("ì „í™”")) show("call");
    else if (text.includes("í™ˆ")) show("home");
    else {
      const product = marketProducts.find(p => text.includes(p.name));
      if (product && (text.includes("ë‹´ì•„ì¤˜") || text.includes("ì¶”ê°€"))) {
        show("market");
        addToCart(product.id);
        speechStatus.textContent = `"${product.name}"ì„(ë¥¼) ë‹´ì•˜ì–´ìš”.`;
      } else {
        speechStatus.textContent = "ëª…ë ¹ì„ ì´í•´í•˜ì§€ ëª»í–ˆì–´ìš”.";
      }
    }
  }

/* ==================== ì‘ê¸‰ í˜¸ì¶œ ==================== */
function makeEmergencyCall(target) {
  if(target === '119') {
    window.location.href = 'tel:119';
  } else if(target === 'guardian') {
    // ë³´í˜¸ì ë²ˆí˜¸ë¥¼ ë¯¸ë¦¬ ì§€ì •í•˜ì„¸ìš”
    const guardianPhone = '01012345678';
    window.location.href = `tel:${guardianPhone}`;
  }
}

/* ==================== ì¹œêµ¬ ì°¾ê¸° ==================== */
async function findNearbyFriends() {
  if (!navigator.geolocation) {
    alert("ì´ ë¸Œë¼ìš°ì €ëŠ” ìœ„ì¹˜ ì„œë¹„ìŠ¤ë¥¼ ì§€ì›í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤.");
    return;
  }

  navigator.geolocation.getCurrentPosition(async (pos) => {
    const { latitude, longitude } = pos.coords;

    try {
      // ìœ„ì¹˜ ì—…ë°ì´íŠ¸
      await fetch("/db/updateLocation", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        credentials: "include",
        body: JSON.stringify({ latitude, longitude }),
      });

      // ê·¼ì²˜ ì¹œêµ¬ ê²€ìƒ‰
      const res = await fetch("/db/nearby", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        credentials: "include",
        body: JSON.stringify({ latitude, longitude }),
      });

      const result = await res.json();
      if (!result.success) {
        alert("ì˜¤ë¥˜: " + result.message);
        return;
      }

      const nearbyFriends = result.data;

      // friends ë°°ì—´ì„ ì„œë²„ì—ì„œ ë°›ì€ ë°ì´í„°ë¡œ ë®ì–´ì“°ê¸°
      // (ì„œë²„ì—ì„œ category/desc ì—†ìœ¼ë©´ ê¸°ë³¸ê°’ ì¶”ê°€)
      const list = nearbyFriends.map(f => ({
        name: f.name || f.id,
        category: f.category || "ì¹œêµ¬",
        desc: f.desc || "ê°™ì´ í™œë™í•  ì¹œêµ¬ì…ë‹ˆë‹¤.",
        phone: f.phone || "010-0000-0000",
        distance: f.distance
      }));

      // ê¸°ì¡´ renderFriends í•¨ìˆ˜ ì¬ì‚¬ìš©
      renderFriends(list);

      // ê° ì¹´ë“œ ì•„ë˜ì— ê±°ë¦¬ í‘œì‹œ
      list.forEach((f, i) => {
        const div = document.getElementById("friends-list").children[i];
        const distanceDiv = document.createElement("div");
        distanceDiv.style.fontSize = "26px";
        distanceDiv.style.marginTop = "6px";
        distanceDiv.textContent = `ê±°ë¦¬: ${Number(f.distance).toFixed(2)} km`;
        div.appendChild(distanceDiv);
      });

      show("friends");

    } catch (err) {
      console.error(err);
      alert("ê·¼ì²˜ ì¹œêµ¬ ì¡°íšŒ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.");
    }
  }, (err) => {
    console.error(err);
    alert("ìœ„ì¹˜ ì •ë³´ë¥¼ ê°€ì ¸ì˜¤ëŠ” ë° ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.");
  });
}

/* ==================== ì¼ì • ë°ì´í„° ==================== */
const scheduleDataOct2025 = {
Â  4: Â { event: 'ê´‘ì–‘, ì˜ê´‘ ì‹œë‹ˆì–´í´ëŸ½ ë‚´ë°©', details: '14:30 (6ëª…)' },
Â  5: Â { event: 'ê¹€ì œì‹œë‹ˆì–´í´ëŸ½ ë‚´ë°©', details: '10:00 (27ëª…)' },
Â  6: Â { event: 'ë‹´ë‹¹ì ì›Œí¬ìƒµ', details: 'ì·¨ì—…ì•Œì„ í˜•, ì‹œë‹ˆì–´ì¸í„´ì‰½' },
Â  8: Â { event: 'ë‹´ë‹¹ì ì›Œí¬ìƒµ', details: 'ì¥ì†Œ: ì œì£¼' },
Â  11: { event: 'ì¸ê³„ë©´ ë¬¸í™”íƒë°©', details: '9:00~, ì „ë¶ ê³ ì°½' },
Â  12: { event: 'ìœ ë“±ë©´ ë¬¸í™”íƒë°© / ë³µì§€ê´€ ìš”ë¦¬êµì‹¤', details: '9:00~, ì „ë¶ ê³ ì°½' }, // 12ì¼ ë³‘í•©
Â  13: { event: 'íŒ”ë•ë©´ ë¬¸í™”íƒë°©', details: '9:30~, ì „ë¶ ê³ ì°½' },
Â  14: { event: 'ì ì„±ë©´ ë¬¸í™”íƒë°©', details: '9:00~, ì „ë¶ ê³ ì°½' },
Â  15: { event: 'ë³µí¥ë©´ ë¬¸í™”íƒë°©', details: '9:30~ (120ëª…), ì „ë¶ ê³ ì°½' },
Â  16: { event: 'ìˆœì°½ë–¡ë³¶ì´í˜ìŠ¤íƒ€ ë¶€ìŠ¤', details: '9:00~, ìˆœì°½êµ° ë¯¼ì†ë§ˆì„' },
Â  17: { event: 'ìˆœì°½ë–¡ë³¶ì´í˜ìŠ¤íƒ€ ë¶€ìŠ¤', details: '9:00~, ìˆœì°½êµ° ë¯¼ì†ë§ˆì„' },
Â  18: { event: 'ê¸ˆê³¼ë©´ ë¬¸í™”íƒë°© / ì†ì£¼ ìƒì¼', details: '9:00~, ì „ë¶ ê³ ì°½' }, // 18ì¼ ë³‘í•©
Â  19: { event: 'ìˆœì°½ì ë¬¸í™”íƒë°©', details: '9:00~, ì „ë¶ ê³ ì°½' },
Â  20: { event: 'ìˆœì°½ì ë¬¸í™”íƒë°©', details: '9:00~, ì „ë¶ ê³ ì°½' },
Â  21: { event: 'íŒ”ë•ë©´ ë¬¸í™”íƒë°©', details: '9:00~, ì „ë¶ ê³ ì°½' },
Â  22: { event: 'ìˆœì°½ì ë¬¸í™”íƒë°© / ê±´ê°•ê²€ì§„', details: '9:00~, ì „ë¶ ê³ ì°½' }, // 22ì¼ ë³‘í•©
Â  25: { event: 'ìš”ë¦¬ êµì‹¤', details: 'ë³µì§€ê´€' },
Â  27: { event: 'ì„ ë„ëª¨ë¸ ë¬¸í™”íƒë°©', details: '9:00~, ì „ë¶ ê³ ì°½' },
Â  30: { event: "ì‹œë‹ˆì–´ ìŒì•…íšŒ" }
};

/* ==================== UI í•¨ìˆ˜ ==================== */
function renderFriends(list = friends) {
  const div = document.getElementById('friends-list');
  div.innerHTML = "";
  list.forEach(f => {
    const card = document.createElement('div');
    card.className = "friend-card";
    card.innerHTML = `
      <div class="friend-name">${f.name}</div>
      <div class="friend-category">ğŸ’¬ ${f.category} ì¹œêµ¬</div>
      <div style="font-size:26px; margin-top:8px;">${f.desc}</div>
      <button onclick="call('${f.phone}', '${f.name}')">ì—°ë½í•˜ê¸°</button>
    `;
    div.appendChild(card);
  });
}

function renderProducts() {
  const productListDiv = document.getElementById('product-list');
  const h2 = productListDiv.querySelector('h2');
  productListDiv.innerHTML = '';
  productListDiv.appendChild(h2);
  marketProducts.forEach(product => {
    const card = document.createElement('div');
    card.className = 'product-card';
    card.innerHTML = `
      <span class="product-info">${product.name} - ${product.price.toLocaleString()}ì›</span>
      <button onclick="addToCart(${product.id})">ë‹´ê¸°</button>
    `;
    productListDiv.appendChild(card);
  });
}

function addToCart(id) {
  const product = marketProducts.find(p => p.id === id);
  if (product) {
    cart.push(product);
    renderCart();
    alert(`${product.name}ì„(ë¥¼) ì¥ë°”êµ¬ë‹ˆì— ë‹´ì•˜ìŠµë‹ˆë‹¤.`);
  }
}

function renderCart() {
  const list = document.getElementById('cart-items');
  const count = document.getElementById('cart-count');
  list.innerHTML = '';
  cart.forEach(item => {
    const li = document.createElement('li');
    li.textContent = `${item.name} (${item.price.toLocaleString()}ì›)`;
    list.appendChild(li);
  });
  count.textContent = cart.length;
}



/* ==================== ë‹¬ë ¥ ==================== */
function renderSchedule() {
Â  const calendarGrid = document.getElementById('calendar-grid');
Â  calendarGrid.innerHTML = '';
Â  const year = 2025, month = 9; // 10ì›” (0ë¶€í„° ì‹œì‘: 0=1ì›”, 9=10ì›”)
Â  const today = new Date();
Â  const firstDay = new Date(year, month, 1).getDay();
Â  const daysInMonth = new Date(year, month + 1, 0).getDate();

Â  for (let i = 0; i < firstDay; i++) {
Â  Â  calendarGrid.innerHTML += '<div class="calendar-day empty"></div>';
Â  }

Â  for (let day = 1; day <= daysInMonth; day++) {
Â  Â  const dayDiv = document.createElement('div');
Â  Â  dayDiv.className = 'calendar-day';
Â  Â  let html = `<div class="day-number">${day}</div>`;
Â  Â  
Â  Â  // "ì˜¤ëŠ˜" ë‚ ì§œ í‘œì‹œ ë¡œì§ ìˆ˜ì •: í˜„ì¬ ë…„/ì›”ê³¼ ë‹¬ë ¥ì˜ ë…„/ì›”ì´ ê°™ê³  ë‚ ì§œë„ ê°™ìœ¼ë©´ 'today' í´ë˜ìŠ¤ ì¶”ê°€
Â  Â  if (day === today.getDate() && month === today.getMonth() && year === today.getFullYear()) {
Â  Â  Â  dayDiv.classList.add('today');
Â  Â  }
Â  Â  
Â  Â  if (scheduleDataOct2025[day]) {
Â  Â  Â  const item = scheduleDataOct2025[day];
Â  Â  Â  html += `<div class="day-event">${item.event}${item.details ? `<span style='font-size:26px;color:#555;'> - ${item.details}</span>` : ''}</div>`;
Â  Â  }
Â  Â  dayDiv.innerHTML = html;
Â  Â  calendarGrid.appendChild(dayDiv);
Â  }
}

/* ==================== ë¡œê·¸ì¸ / ì´ˆê¸°í™” ==================== */
function initializeMainApp() {
  renderSchedule();
  renderFriends();
  renderProducts();
  renderCart();
}

/* ==================== ì´ë²¤íŠ¸ ë“±ë¡ ==================== */
document.addEventListener("DOMContentLoaded", () => {
  // í—¤ë” í´ë¦­ â†’ í™ˆìœ¼ë¡œ
  document.querySelector('.header-title').onclick = () => show('home');
  
  document.querySelector('#alarm-icon').onclick = () => show('alerts');

  // í•˜ë‹¨ ë©”ë‰´ í´ë¦­ ì´ë²¤íŠ¸ ë“±ë¡
  document.querySelectorAll('.nav-btn').forEach(btn => {
    btn.addEventListener('click', () => {
      const target = btn.dataset.target;
      show(target);
    });
  });

  // ê¸°ì¡´ ì´ˆê¸°í™”
  initializeMainApp();
});



/* ==================== ì „í™” ==================== */
function call(phone, name) {
  alert(`${name}ë‹˜ê³¼ ì—°ê²°ì„ ì‹œë„í•©ë‹ˆë‹¤.\n${phone}`);
  window.location.href = `tel:${phone}`;
}
</script>
</body>
</html>
