<!doctype html>
<html lang="ko">
<head>
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Noto+Sans+KR:wght@400;700;900&display=swap" rel="stylesheet">
<link rel="stylesheet" href="/raspi.css">
<script defer src="/raspi.js"></script>

<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=no">
<title>VitaMind - ì‹œë‹ˆì–´ í—¬ìŠ¤ì¼€ì–´</title>
<style>
  body, html {
    margin: 0;
    padding: 0;
    background-color: #F8F9FA;
    font-family: "Noto Sans KR", sans-serif;
    font-size: 28px;
    font-weight: 700;
  }
  .app {
    width: 100%;
    height: 100vh;
    display: flex;
    flex-direction: column;
    background-color: #fff;
  }

  header {
    background-color: #00796B;
    color: #fff;
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 20px 30px;
    font-size: 40px;
    font-weight: 900;
  }
  #alarm-icon { cursor: pointer; }
  .header-title { cursor: pointer; }
  .header-icons { display: flex; align-items: center; gap: 20px; }
  .mic-button {
    background: none; border: none; color: white;
    font-size: 50px; cursor: pointer; 
  }
  .mic-button.active { color: #FF5722; }

  .logout-button {
      font-size: 30px; background: none; color: white;
      border: 3px solid white; border-radius: 15px; padding: 10px 20px;
      cursor: pointer; font-weight: bold;
  }

  .speech-overlay {
    position: fixed; top: 0; left: 0;
    width: 100%; height: 100%;
    background-color: rgba(0, 0, 0, 0.7);
    color: white; display: flex; justify-content: center; align-items: center;
    font-size: 36px; text-align: center; z-index: 100;
    opacity: 0; visibility: hidden;
    transition: opacity 0.3s, visibility 0.3s;
  }
  .speech-overlay.visible { opacity: 1; visibility: visible; }

  main { flex: 1; padding: 30px; overflow-y: auto; }
  section { display: none; }
  section.active { display: block; }
  h2 { font-size: 42px; }

  .home-menu {
    display: grid; grid-template-columns: 1fr 1fr; gap: 25px; margin-top: 30px;
  }
  .home-menu button {
    padding: 40px 20px; font-size: 32px; font-weight: bold;
    border: 2px solid #00796B; border-radius: 15px;
    background-color: #E0F2F1; color: #004D40; cursor: pointer;
  }

  .friend-card {
    border: 2px solid #BDBDBD; border-radius: 15px;
    padding: 25px; margin-bottom: 20px;
    background-color: #FAFAFA;
  }
  .friend-name { font-size: 34px; font-weight: 900; color: #004D40; }
  .friend-category { font-size: 26px; color: #555; }
  .friend-card button {
    font-size: 28px; padding: 10px 20px;
    border: none; background-color: #00796B; color: #fff;
    border-radius: 10px; cursor: pointer; margin-top: 10px;
  }

  .product-card {
    border: 2px solid #BDBDBD; border-radius: 15px;
    padding: 25px; margin-bottom: 20px;
    display: flex; justify-content: space-between; align-items: center;
  }
  .product-info { font-size: 30px; }
  .product-card button {
    font-size: 30px; padding: 15px 25px;
    border: none; background-color: #00796B;
    color: #fff; border-radius: 10px; cursor: pointer;
  }

  nav {
    display: flex; justify-content: space-around;
    background-color: #fff; border-top: 3px solid #eee;
    padding: 20px 0;
  }
  .nav-btn {
    flex: 1; text-align: center; font-size: 32px;
    cursor: pointer; padding: 10px 0;
    
  }
  .nav-btn.active {
    color: #00796B; font-weight: 900;
    background-color : #E0F2F1 !important;
    margin: -20px 0; /* navì˜ paddingë§Œí¼ ìœ„ì•„ë˜ í™•ì¥ */
    padding: 30px 0; /* ëˆŒë¦¬ì§€ ì•Šê²Œ ì—¬ìœ  ì¶”ê°€ */
  }
  #e119 {
    background-color : #D32F2F !important; 
    color: white !important;
    border-color: #B71C1C !important;
    margin: -20px 0; /* navì˜ paddingë§Œí¼ ìœ„ì•„ë˜ í™•ì¥ */
    padding: 30px 0; /* ëˆŒë¦¬ì§€ ì•Šê²Œ ì—¬ìœ  ì¶”ê°€ */
  }

  /* ====== ê¸´ê¸‰ ì—°ë½ ë²„íŠ¼ ====== */
  .emergency-btn {
    background-color : #D32F2F !important; 
    color: white !important;
    border-color: #B71C1C !important;

    animation: blink 2s infinite;
  }

  @keyframes blink { 
    0% { 
      transform: scale(1);
      box-shadow: 0 0 0 0 rgba(211, 47, 47, 0.7); 
    }
    70% { 
      transform: scale(1.05); 
      box-shadow: 0 0 0 20px rgba(211, 47, 47, 0); 
    } 
    100% { 
      transform: scale(1); 
      box-shadow: 0 0 0 0 rgba(211, 47, 47, 0); 
    } 
  }

  /* ====== ë‹¬ë ¥ ìŠ¤íƒ€ì¼ ====== */
  #calendar-grid {
    display: grid;
    grid-template-columns: repeat(7, 1fr);
    gap: 8px;
    margin-top: 20px;
  }
  .calendar-day {
    border: 1px solid #ccc;
    border-radius: 10px;
    padding: 10px;
    min-height: 80px;
    font-size: 28px;
    background-color: #FAFAFA;
  }
  .calendar-day.today { background-color: #C8E6C9; }
  .calendar-day.empty { background: none; border: none; }
  .day-event { color: #00796B; font-size: 26px; margin-top: 6px; }

  /* ====== ì§€ë„ ê¸°ëŠ¥ ====== */
    #kakaoMapContainer {
      width: 100%;
      height: 400px;
    }

    #container {
      display: flex;
      height: 500px; /* ìµœì†Œ ë†’ì´ ì§€ì • */
    }

    /* === ì¥ë³´ê¸°(ì‹œì¥ & ë³µì§€ê´€) ì‚¬ì´ë“œë°” ìŠ¤íƒ€ì¼ test.html ë™ì¼ === */
#sidebar {
  font-family: "Noto Sans KR", sans-serif;
  background: #fff;
  padding: 16px;
  overflow-y: auto;
}
.place-item {
  background: #fafafa;
  border-radius: 10px;
  padding: 12px;
  margin-bottom: 8px;
  cursor: pointer;
  transition: background 0.2s;
}
.place-item:hover {
  background: #c8f7e8;
}
.place-item div:first-child {
  color: #00796B; /* ì‹œì¥ ì´ë¦„ */
  font-weight: 700;
}
.place-item div:last-child {
  color: #555; /* ì£¼ì†Œ */
}

.alert-btn {
    border: 2px solid #ff9900; /* ì£¼í™©ìƒ‰ í…Œë‘ë¦¬ */
    background-color: #fff;      /* ë°°ê²½ìƒ‰ í°ìƒ‰ */
    color: #ff9900;              /* ê¸€ììƒ‰ ì£¼í™©ìƒ‰ */
    padding: 5px 10px;           /* ë²„íŠ¼ ì•ˆ ì—¬ë°± */
    border-radius: 8px;          /* ëª¨ì„œë¦¬ ë‘¥ê¸€ê²Œ */
    cursor: pointer;             /* ë§ˆìš°ìŠ¤ ì˜¬ë¦¬ë©´ í¬ì¸í„° */
    font-size: 14px;
    transition: all 0.2s ease;   /* ì‚´ì§ ë¶€ë“œëŸ¬ìš´ íš¨ê³¼ */
  }

  .alert-btn:hover {
    background-color: #ff9900;   /* ë§ˆìš°ìŠ¤ ì˜¤ë²„ ì‹œ ë°°ê²½ ì£¼í™©ìƒ‰ */
    color: #fff;                 /* ê¸€ììƒ‰ í°ìƒ‰ */
  }
    </style>
  <script>
// í˜ì´ì§€ ì–´ë””ì„œë“  ê°€ì¥ ë¨¼ì € ì‹¤í–‰ë˜ê²Œ ë„£ì–´
localStorage.removeItem('rasp_base');     // ê³¼ê±°ì— ì €ì¥ëœ ê°’ ì œê±°
window.rasp_base = location.origin + '/rapi';
</script>

  <!-- Kakao Maps API ë¶ˆëŸ¬ì˜¤ê¸° -->
  <script src="https://dapi.kakao.com/v2/maps/sdk.js?appkey=433a059560072e066820d8b58d1e68f7&autoload=false&libraries=services"></script>

  <!-- ìƒˆ ì¼ì • ì¶”ê°€í•˜ê¸° -->
  <script src="https://cdn.tailwindcss.com"></script>
</head>
<body>
<div class="app">
  <header>
    <div id="alarm-icon">ğŸ””</div>
    <div class="header-title">VitaMind</div>
    <div class="header-icons">
      <span id="gps-badge" style="margin-left:12px; font-size:20px; background:#fff; color:#004d40; border:2px solid #00796B; border-radius:12px; padding:4px 8px;">
  ğŸ“ --
</span>
<span id="pir-dot" title="pir" style="display:inline-block; width:12px; height:12px; border-radius:50%; background:#9e9e9e; margin-left:8px; vertical-align:middle;"></span>
      <button class="mic-button" id="micButton" onclick="toggleMic()">ğŸ¤</button>
      <button class="logout-button" onclick="logout()">ë¡œê·¸ì•„ì›ƒ</button>
      
    </div>
    
  </header>

  <div class="speech-overlay" id="speechOverlay">
    <div id="speechStatus">ìŒì„± ì¸ì‹ ëŒ€ê¸° ì¤‘...</div>
  </div>

  <main>
    <!-- í™ˆ -->
    <section id="home" class="active">
      <div id="dht-banner" style="background:#fff9c4; border:2px solid #fbc02d; border-radius:12px; padding:12px 14px; margin:8px 0 16px; color:#444; font-weight:700; font-size:22px;">
  ğŸŒ¡ ì¸¡ì • ëŒ€ê¸°...
</div>
<!-- [ì¶”ê°€] ì‹œë®¬ë ˆì´ì…˜ ì•Œë¦¼ ë°°ë„ˆ -->
<div id="sim-alert-banner" style="background:#ffe0e0;border:2px solid #ff5252;border-radius:12px;padding:12px 14px;margin:8px 0 16px;color:#b00020;font-weight:700;font-size:20px;display:none;">
  ì•Œë¦¼ ì—†ìŒ
</div>
<div style="display:flex;gap:8px;margin-bottom:12px;">
  <button id="sim-ack" style="padding:8px 12px;border-radius:8px;border:1px solid #ccc;background:#fff;">í™•ì¸</button>
  <button id="sim-mock-alert" style="padding:8px 12px;border-radius:8px;border:1px solid #ccc;background:#fff;">ê°€ì§œ ê²½ë³´</button>
  <button id="sim-mock-motion" style="padding:8px 12px;border-radius:8px;border:1px solid #ccc;background:#fff;">ê°€ì§œ ì›€ì§ì„</button>
  <button id="sim-log-open" style="padding:8px 12px;border-radius:8px;border:1px solid #ccc;background:#fff;">ë¡œê·¸ ë³´ê¸°</button>
</div>
<pre id="sim-log" style="display:none;background:#111;color:#0f0;padding:10px;border-radius:8px;max-height:200px;overflow:auto;"></pre>

      <h2>ğŸ  ì–´ì„œì˜¤ì„¸ìš”! VitaMindì…ë‹ˆë‹¤. ğŸ‘¥</h2>
      <p style="font-size:28px; font-weight:normal; margin-bottom:40px;">
        "ì¹œêµ¬ ì°¾ì•„ì¤˜", "ë°°ì¶” ë‹´ì•„ì¤˜" ë¼ê³  ë§ì”€í•´ë³´ì„¸ìš”.
      </p>
      <div class="home-menu">
        <button onclick="show('friends')">ğŸ‘¥<br>ì¹œêµ¬</button>
        <button onclick="show('mapSection')">ğŸ›’<br>ì¥ë³´ê¸°</button>
        <button onclick="show('map')">ğŸ—ºï¸<br>ì§€ë„</button>
        <button onclick="show('schedule')">ğŸ“…<br>ìš°ë¦¬ë“¤ì˜ ì¼ì •</button>
        <button onclick="show('emergency')" class="emergency-btn">ğŸš¨<br>ê¸´ê¸‰ ì—°ë½</button>
        <button id="open-dashboard">ëŒ€ì‹œë³´ë“œ ì ‘ì†</button>
      </div>
      <div style="margin-top:18px; text-align:center;">
        <button onclick="findNearbyFriends()" style="padding:14px 20px; font-size:28px; border-radius:12px; border:2px solid #00796B; background:#E0F2F1; cursor:pointer;">
          ğŸ“ ê·¼ì²˜ ì¹œêµ¬ ì°¾ê¸°
        </button>
      </div>
    </section>
    <script>
  document.getElementById('open-dashboard').addEventListener('click', () => {
    window.location.href = '/admin';   // ì„œë²„1ì— ì´ì‹ëœ ê´€ë¦¬ì ëŒ€ì‹œë³´ë“œ ë¼ìš°íŠ¸
  });
</script>


    <!-- ì¹œêµ¬ ëª©ë¡ -->
    <section id="friends">

      <div style="display: flex; justify-content: space-between; align-items: center;">
        <!-- ì˜¤ë¥¸ìª½ ë²„íŠ¼ -->
        <h2>ğŸ‘¥ ì¹œêµ¬</h2>
        <button id="FriendrequestBtn" style="padding: 6px 12px; border-radius: 6px; border: 1px solid #ccc; background-color: #f1f1f1;">â• ì¹œêµ¬ ìš”ì²­</button>
      </div>
      <!-- âœ… ê²€ìƒ‰ì°½ ì¶”ê°€ ë¶€ë¶„ -->
      <div style="margin-bottom: 10px;">
        <input type="text" id="searchInput" placeholder="ì¹œêµ¬ ì´ë¦„ì„ ì…ë ¥í•˜ì„¸ìš”">
        <button id="searchBtn">ğŸ” ê²€ìƒ‰</button>
      </div>
      <div id="friends-list"></div>
    </section>

    <section id="friendssearch">
      <button id="backToFriendsBtn" style="padding:10px 16px; font-size:24px; margin-bottom:12px; cursor:pointer;">
        â¬…ï¸ ì¹œêµ¬ ëª©ë¡ìœ¼ë¡œ ëŒì•„ê°€ê¸°
      </button>
      <div id="friends-search"></div>
    </section>
    
    <!-- ì¹œêµ¬ ì°¾ê¸° -->

    <section id="friendsfind">
      <h2>ğŸ‘¥ ì¹œêµ¬ ì°¾ê¸°</h2>
      <div id="friends-find"></div>
    </section>

    <!-- âœ… ìƒˆ ì‹œì¥ & ë³µì§€ê´€ ì°¾ê¸° ê¸°ëŠ¥ -->
      <section id="mapSection">
        <h2>ğŸ›’ ë‚´ ì£¼ë³€ ì‹œì¥ & ë³µì§€ê´€ ì°¾ê¸°</h2>

        <div id="search-box" style="margin: 15px 0; text-align: center;">
          <input id="marketKeyword" type="text" placeholder="ì‹œì¥ ë˜ëŠ” ë³µì§€ê´€ì„ ê²€ìƒ‰í•˜ì„¸ìš”"
                style="width:60%; padding:10px; font-size:1.05rem; border:2px solid #00796B; border-radius:8px;">
          <button id="marketSearchBtn"
                  style="margin-left:10px; padding:10px 16px; border:0; border-radius:8px; background:#00796B; color:#fff; font-size:1.05rem; cursor:pointer;">
            ğŸ” ê²€ìƒ‰
          </button>
        </div>

        <div id="container" style="display:flex; flex:1; min-height:0; overflow:hidden;">
          <div id="sidebar" style="display:none; width:380px; background:#fff; border-right:1px solid #ccc; overflow-y:auto; padding:10px;">
            <div id="list-box"></div>
          </div>
          <div id="detail-panel" style="display:none; width:400px; background:#fff; border-right:1px solid #ccc; overflow-y:auto; padding:20px;"></div>
          <div id="marketMap" style="flex:1; height:80vh;"></div>
        </div>
      </section>

    <!-- ì•Œë¦¼ -->
    <section id="alerts">
      <h2>ğŸ”” ì•Œë¦¼</h2>
      
      <ul style="font-size:28px;">
        <li>10ì›” 22ì¼ - ê±´ê°•ê²€ì§„</li>
        <li>10ì›” 25ì¼ - ë³µì§€ê´€ ìš”ë¦¬ êµì‹¤</li>
        <li>10ì›” 30ì¼ - ì‹œë‹ˆì–´ ìŒì•…íšŒ</li>
      </ul>
    </section>

    <!-- ì „í™” -->
    <section id="call">
      <h2>ğŸ“ ì „í™” ê±¸ê¸°</h2>
      <p style="font-size:30px;">"ê°€ì¡±ì—ê²Œ ì „í™”í•´ì¤˜", "ë³µì§€ê´€ ì „í™”í•´ì¤˜"ë¼ê³  ë§í•´ë³´ì„¸ìš”.</p>
    </section>

    <!-- ì¼ì • -->
    <section id="schedule">
      <h2>ğŸ“… 2025ë…„ 10ì›” ì¼ì •</h2>
      

  <button onclick="window.open('ì•Œë¦¼.html', '_blank')" 
    style="margin-top:20px; padding:20px; font-size:30px; border-radius:15px; background:#00796B; color:#fff;">
    <!-- ê´€ë¦¬ì ì¼ì • ì¶”ê°€í•˜ê¸° -->
    â• ìƒˆ ì¼ì • ì¶”ê°€í•˜ê¸°
    </button>

      <div id="calendar-grid"></div>
    </section>

    <!-- ì§€ë„ -->
    <section id="map">
      <h1>ğŸ—ºï¸ ë‚´ ì£¼ë³€ ì§€ë„</h1>
      <div id="kakaoMapContainer" style="width:80%;height:400px;"></div>
    </section>
    

    <!-- ===== ì‘ê¸‰ ì„¹ì…˜ ì¶”ê°€ ===== -->
    <section id="emergency">
      <div class="content-pane">
        <h2>ğŸš¨ ì‘ê¸‰ ìƒí™©</h2>
        <p style="font-size:35px;">"ë„ì™€ì¤˜", "119" ë“±ì„ ë§ì”€í•˜ì„¸ìš”.</p>
        <button onclick="makeEmergencyCall('119')" class="emergency-btn"
              style="width:100%; padding: 30px; font-size: 40px; margin-top:20px;">
          ğŸ“ 119 ì¦‰ì‹œ ì—°ê²°
        </button>
        <button onclick="makeEmergencyCall('guardian')" style="width:100%; padding: 30px; font-size: 40px; margin-top:20px;">
          ğŸ‘¨â€ğŸ‘©â€ğŸ‘§ ë³´í˜¸ìì—ê²Œ ì—°ë½
        </button>
      </div>
    </section>
    
  </main>

  <nav>
    <div class="nav-btn active" data-target="home">í™ˆ</div>
    <div class="nav-btn" data-target="friends">ì¹œêµ¬</div>
    <div class="nav-btn" data-target='mapSection'>ì‹œì¥</div>
    <div class="nav-btn" data-target="map">ì§€ë„</div>
    <div class="nav-btn" data-target="schedule">ì¼ì •</div>
    <div class="nav-btn" data-target="friendsfind">ì¹œêµ¬ ì°¾ê¸°</div>
    <div id="e119" class="nav-btn" data-target="emergency">ì‘ê¸‰</div>
  </nav>
</div>

<script>
// ê²€ìƒ‰ ê²°ê³¼ì—ì„œ ì¹œêµ¬ ì„¹ì…˜ìœ¼ë¡œ ëŒì•„ê°€ê¸°
document.getElementById("backToFriendsBtn").addEventListener("click", async () => {
  // friends ì„¹ì…˜ ë³´ì—¬ì£¼ê¸°
  show("friends");

  // DBì—ì„œ ì „ì²´ ì¹œêµ¬ ëª©ë¡ ë‹¤ì‹œ ë¡œë“œ
  try {
    const res = await fetch("/db/getFriends", { method: "GET", credentials: "include" });
    const data = await res.json();
    if (res.ok && data.success) {
      friendsData1 = data.friends;  // ê²€ìƒ‰ìš© ì „ì—­ ë³€ìˆ˜ ì—…ë°ì´íŠ¸
      renderFriends(friendsData1);   // ì „ì²´ ì¹œêµ¬ ëª©ë¡ ë Œë”
    } else {
      friendsData1 = [];
      renderFriends();
    }
  } catch (err) {
    console.error(err);
    friendsData1 = [];
    renderFriends();
  }
});

// ì „ì—­ ë³€ìˆ˜ë¡œ ì¹œêµ¬ ë°ì´í„° ì €ì¥
let friendsData1 = [
  { name: "ê¹€ì˜ì", category: "ìš´ë™", desc: "ë§¤ì¼ ì•„ì¹¨ ìš´ë™", phone: "01012345678" },
  { name: "ë°•ì² ìˆ˜", category: "ì‚°ì±…", desc: "ì €ë… ì‚°ì±…", phone: "01023456789" }
];

// friends ì„¹ì…˜ ì§„ì… ì‹œ ì¹œêµ¬ ëª©ë¡ ê°€ì ¸ì˜¤ê¸°
async function loadFriends() {
  try {
    const res = await fetch("/db/getFriends", { 
      method: "GET", 
      credentials: "include" 
    });
    const data = await res.json();
    if (data.success && Array.isArray(data.friends)) {
      friendsData1 = data.friends;
      renderFriends(friendsData1); // í™”ë©´ ë Œë”
    } else {
      friendsData1 = [];
      renderFriends();
    }
  } catch (err) {
    console.error(err);
    friendsData1 = [];
    renderFriends();
  }
}

// ê²€ìƒ‰ ë²„íŠ¼ ì´ë²¤íŠ¸
document.getElementById("searchBtn").addEventListener("click", () => {
  const keyword = document.getElementById("searchInput").value.trim();
  const container = document.getElementById("friends-search");
  container.innerHTML = "";

  if (!keyword) {
    alert("ê²€ìƒ‰ì–´ë¥¼ ì…ë ¥í•˜ì„¸ìš”.");
    return;
  }

  // ì „ì—­ friendsData ê¸°ë°˜ ê²€ìƒ‰
  const filtered = friendsData1.filter(f => f.name.includes(keyword));
  if (filtered.length === 0) {
    container.innerHTML = "<p>ê²€ìƒ‰ ê²°ê³¼ê°€ ì—†ìŠµë‹ˆë‹¤.</p>";
    return;
  }

  filtered.forEach(f => {
    const card = document.createElement("div");
    card.className = "friend-card";
    card.innerHTML = `
      <div class="friend-name">${f.name}</div>
      <div class="friend-category">${f.hobby || f.category} ì¹œêµ¬</div>
      <div style="font-size:26px; margin-top:8px;">ğŸ’¬ ${f.profile_text || ""}</div>
      <button onclick="call('${f.phone}', '${f.name}')">ì—°ë½í•˜ê¸°</button>
    `;

    
    container.appendChild(card);
  });

  show("friendssearch");



});

// friends ì„¹ì…˜ show ì‹œ ìë™ìœ¼ë¡œ ë¡œë“œ
const navFriendsBtn = document.querySelector(".nav-btn[data-target='friends']");
if (navFriendsBtn) {
  navFriendsBtn.addEventListener("click", () => loadFriends());
}

// friends ì„¹ì…˜ì— ì§„ì…í•  ë•Œ ê¸°ë³¸(local) ë¦¬ìŠ¤íŠ¸ë¥¼ ìë™ìœ¼ë¡œ ë Œë”í• ì§€ë¥¼ ì œì–´í•˜ëŠ” í”Œë˜ê·¸
let suppressFriendsRender = false;

/* ==================== ë¡œê·¸ì•„ì›ƒ ==================== */
async function logout() { 
  if (confirm('ë¡œê·¸ì•„ì›ƒ í•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) { 
    try {
      // 1. ì„œë²„ì— ë¡œê·¸ì•„ì›ƒ ìš”ì²­ (ì„¸ì…˜ íŒŒê´´)
      const res = await fetch('/db/logout', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        credentials: 'include' // ì„¸ì…˜/ì¿ í‚¤ ì •ë³´ ì „ì†¡ í•„ìˆ˜
      });

      if (!res.ok) {
        throw new Error('ì„œë²„ì—ì„œ ë¡œê·¸ì•„ì›ƒ ì‹¤íŒ¨');
      }

      // 2. í´ë¼ì´ì–¸íŠ¸ ì¸¡ ë°ì´í„° ì œê±°
      localStorage.removeItem('isLoggedIn'); 
      localStorage.removeItem('loggedInUser'); 
      // loggedInUser = null; // ì‚¬ìš©ë˜ì§€ ì•ŠëŠ” ì „ì—­ ë³€ìˆ˜ ì´ˆê¸°í™” ì½”ë“œëŠ” ì œê±°í•˜ê±°ë‚˜ ì£¼ì„ ì²˜ë¦¬

      // 3. ë©”ì¸ í˜ì´ì§€ë¡œ ì´ë™
      window.location.href = 'main.html';
    } catch (err) {
      console.error("ë¡œê·¸ì•„ì›ƒ ì˜¤ë¥˜:", err);
      alert("ë¡œê·¸ì•„ì›ƒ ì²˜ë¦¬ ì¤‘ ë¬¸ì œê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤. ë‹¤ì‹œ ì‹œë„í•´ì£¼ì„¸ìš”.");
    }
  } 
}



/* ==================== ì§€ë„ ì¤‘ì‹¬ ì¢Œí‘œ (ì˜ˆ: ì„œìš¸) ==================== */
  let map = null; // ì§€ë„ ê°ì²´ë¥¼ ì €ì¥í•  ì „ì—­ ë³€ìˆ˜
let myMarker;
let myLabel;
let otherUserMarkers = [];
let locationUpdateInterval;
let otherUserFetchInterval;

      // âœ… ë‚´ ìœ„ì¹˜ ë§ˆì»¤ & ë¼ë²¨ ì¶”ê°€
function showMyMarker(lat, lng) {  
  const pos = new kakao.maps.LatLng(lat, lng);

  if (myMarker) myMarker.setMap(null);
  myMarker = new kakao.maps.Marker({
    map: map,
    position: pos,
    image: new kakao.maps.MarkerImage(
      "https://t1.daumcdn.net/localimg/localimages/07/mapapidoc/markerStar.png",
      new kakao.maps.Size(34, 34)
    )
  });

  if (myLabel) myLabel.setMap(null);
  const labelContent = `
    <div style="
      background: white;
      border: 1.5px solid #333;
      padding: 3px 8px;
      font-size: 14px;
      border-radius: 6px;
      white-space: nowrap;
      transform: translate(-50%, -45%);
    ">
      ğŸ“ ë‚˜
    </div>
  `;

  myLabel = new kakao.maps.CustomOverlay({
    position: pos,
    content: labelContent,
    yAnchor: 1.5
  });

  myLabel.setMap(map);
}   


function initMap() {
  const mapContainer = document.getElementById('kakaoMapContainer');
  if (!mapContainer) return;

  map = new kakao.maps.Map(mapContainer, {
    center: new kakao.maps.LatLng(35.1515, 126.9091),
    level: 4
  });

  // âœ… ë‚´ ìœ„ì¹˜ ê°€ì ¸ì˜¤ê¸°
  if (navigator.geolocation) {
    navigator.geolocation.getCurrentPosition(async (position) => {
      const lat = position.coords.latitude;
      const lng = position.coords.longitude;
      const myLatLng = new kakao.maps.LatLng(lat, lng);

      map.setCenter(myLatLng);

      


      // ì„œë²„ë¡œ ë‚´ ìœ„ì¹˜ ì „ì†¡ (ì˜ˆì‹œ)
      await updateMyLocation(lat, lng);
      showMyMarker(lat, lng);   // âœ… ë‚´ ìœ„ì¹˜ í‘œì‹œ ì‹¤í–‰


      // âœ… ì¹œêµ¬ ìœ„ì¹˜ í‘œì‹œ
      fetchFriendsLocation();

      // ì£¼ê¸°ì  ì—…ë°ì´íŠ¸
      locationUpdateInterval = setInterval(() => updateMyLocation(lat, lng), 5000);
      otherUserFetchInterval = setInterval(() => fetchFriendsLocation(), 5000);


    }, () => alert("ìœ„ì¹˜ ì •ë³´ë¥¼ ë¶ˆëŸ¬ì˜¬ ìˆ˜ ì—†ìŠµë‹ˆë‹¤."), { enableHighAccuracy: true });
  } else {
    alert("ë¸Œë¼ìš°ì €ì—ì„œ ìœ„ì¹˜ ì„œë¹„ìŠ¤ë¥¼ ì§€ì›í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤.");
  }
}

async function updateMyLocation(lat, lng) {
  try {
    await fetch("/db/updateLocation", {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      credentials: "include",
      body: JSON.stringify({ latitude: lat, longitude: lng })
    });
  } catch (err) {
    console.error("ë‚´ ìœ„ì¹˜ ì—…ë°ì´íŠ¸ ì˜¤ë¥˜:", err);
  }
}


// âœ… ì„œë²„ì—ì„œ ì¹œêµ¬ ìœ„ì¹˜ ê°€ì ¸ì˜¤ê¸°
async function fetchFriendsLocation() {
  try {
    const res = await fetch("/db/getFriendsLocation", {
      method: "GET",
      credentials: "include"
    });

    const data = await res.json();
    if (!data.success) return;

    const friends = data.friends;

    // ê¸°ì¡´ ì¹œêµ¬ ë§ˆì»¤ ì œê±°
    otherUserMarkers.forEach(marker => marker.setMap(null));
    otherUserMarkers = [];

    friends.forEach(friend => {
      const marker = new kakao.maps.Marker({
        map: map,
        position: new kakao.maps.LatLng(friend.latitude, friend.longitude)
      });

      const info = new kakao.maps.InfoWindow({
        content: `<div style="padding:3px 5px; font-size:12px;">ğŸ‘¤ ${friend.name}</div>`
      });

      kakao.maps.event.addListener(marker, 'click', () => {
        info.open(map, marker);
      });

      otherUserMarkers.push(marker);
    });

  } catch (err) {
    console.error("ì¹œêµ¬ ìœ„ì¹˜ ë¶ˆëŸ¬ì˜¤ê¸° ì˜¤ë¥˜:", err);
  }
}

// ===== UI í•¨ìˆ˜ (ìˆ˜ì •ë¨) =====
async function show(id) {
  // ëª¨ë“  section ìˆ¨ê¸°ê¸°
  document.querySelectorAll("section").forEach(s => s.classList.remove("active"));
  const section = document.getElementById(id);
  if (!section) return;

  section.classList.add("active");

  // âœ… ì¹œêµ¬ ëª©ë¡
  if (id === 'friends') {
    fetch("/db/getFriends", { method: "GET", credentials: "include" })
      .then(res => res.json())
      .then(data => {
        if (data.success) {
          friendsData1 = data.friends;  // ğŸ”¹ DB ë°ì´í„°ë¥¼ ê²€ìƒ‰ìš© ë³€ìˆ˜ì— ì €ì¥
          renderFriends(friendsData1);
        } else {
          friendsData1 = [];
          renderFriends();
        }
      })
      .catch(err => { 
        console.error(err); 
        friendsData1 = [];
        renderFriends(); 
      });
  }

  if (id === 'map') {
  if (!map) {
    kakao.maps.load(() => initMap());
  } else {
    setTimeout(() => {
      map.relayout();
      if (myMarker) map.setCenter(myMarker.getPosition());
    }, 200);
  }

  fetchFriendsLocation();

  const mapContainer = document.getElementById('kakaoMapContainer');
  if (!mapContainer) return;

  if (map) {
    map.relayout();
    if (myMarker) {
      map.setCenter(myMarker.getPosition());
    }
  }
}

  if (id === 'mapSection') {
  initMarketMap();
  setTimeout(() => {
    if (map2 && myPosition) {
      map2.relayout();
      map2.setCenter(myPosition);
    }
  }, 800); // ì§€ë„ í‘œì‹œ í›„ ë³´ì •
}

  // í•˜ë‹¨ ë©”ë‰´ í™œì„±í™”
  document.querySelectorAll(".nav-btn").forEach(b => 
    b.classList.toggle("active", b.dataset.target === id)
  );
}

function getCookie(name) {
    const value = `; ${document.cookie}`;
    const parts = value.split(`; ${name}=`);
    if (parts.length === 2) return parts.pop().split(";").shift();
  }

  const navButtons = document.querySelectorAll('.nav-btn');
  navButtons.forEach(btn => {
    btn.addEventListener('click', () => show(btn.dataset.target));
  });

 

  function call(phone, name) {
    alert(`${name}ë‹˜ê³¼ ì—°ê²°ì„ ì‹œë„í•©ë‹ˆë‹¤.
    ${phone}`
    )
    window.location.href = `tel:${phone}`;
  }

  // ===== ìŒì„± ì¸ì‹ =====
  let recognizing = false;
  let recognition;
  const micBtn = document.getElementById('micButton');
  const speechOverlay = document.getElementById('speechOverlay');
  const speechStatus = document.getElementById('speechStatus');

  if ('webkitSpeechRecognition' in window) {
    recognition = new webkitSpeechRecognition();
    recognition.lang = "ko-KR";
    recognition.continuous = false;
    recognition.interimResults = false;

    recognition.onstart = () => {
      recognizing = true;
      micBtn.classList.add("active");
      speechStatus.textContent = "ë“£ê³  ìˆì–´ìš”...";
      speechOverlay.classList.add("visible");
    };

    recognition.onresult = event => {
      const text = event.results[0][0].transcript.trim();
      speechStatus.textContent = `"${text}"`;
      handleVoiceCommand(text);
    };

    recognition.onend = () => {
      recognizing = false;
      micBtn.classList.remove("active");
      setTimeout(() => speechOverlay.classList.remove("visible"), 1500);
    };
  } else {
    alert("ì´ ë¸Œë¼ìš°ì €ëŠ” ìŒì„±ì¸ì‹ì„ ì§€ì›í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤.");
    micBtn.style.display = "none";
  }

  function toggleMic() {
    if (!recognition) return;
    if (recognizing) recognition.stop();
    else recognition.start();
  }

  // ===== ìŒì„± ëª…ë ¹ ì²˜ë¦¬ =====
  function handleVoiceCommand(text) {
    if (text.includes("ì¹œêµ¬") && (text.includes("ì°¾ì•„") || text.includes("ì°¾ì•„ì¤˜") || text.includes("ê·¼ì²˜"))) {
      // "ì¹œêµ¬ ì°¾ì•„ì¤˜", "ê·¼ì²˜ ì¹œêµ¬" ë“±ì¼ ê²½ìš° ê·¼ì²˜ ì°¾ê¸° ì‹¤í–‰
      findNearbyFriends();
      return;
    }

    if (text.includes("ì¹œêµ¬")) {
      show("friends");
      renderFriends();
    } 
    else if (["ìš´ë™","ì‚°ì±…","ìš”ë¦¬","ì˜í™”","ìŒì•…"].some(c => text.includes(c))) {
      show("friends");
      const category = ["ìš´ë™","ì‚°ì±…","ìš”ë¦¬","ì˜í™”","ìŒì•…"].find(c => text.includes(c));
      renderFriends(friends.filter(f => f.category === category));
      speechStatus.textContent = `${category} ì¹œêµ¬ë¥¼ ë³´ì—¬ë“œë¦´ê²Œìš”.`;
    }
    else if (text.includes("ì‹œì¥") || text.includes("ì¥ë³´ê¸°")) show("market");
    else if (text.includes("ì•Œë¦¼")) show("alerts");
    else if (text.includes("ì „í™”")) show("call");
    else if (text.includes("í™ˆ")) show("home");
    else {
      const product = marketProducts.find(p => text.includes(p.name));
      if (product && (text.includes("ë‹´ì•„ì¤˜") || text.includes("ì¶”ê°€"))) {
        show("market");
        addToCart(product.id);
        speechStatus.textContent = `"${product.name}"ì„(ë¥¼) ë‹´ì•˜ì–´ìš”.`;
      } else {
        speechStatus.textContent = "ëª…ë ¹ì„ ì´í•´í•˜ì§€ ëª»í–ˆì–´ìš”.";
      }
    }
  }

/* ==================== ì‘ê¸‰ í˜¸ì¶œ ==================== */
function makeEmergencyCall(target) {
  if(target === '119') {
    window.location.href = 'tel:119';
  } else if(target === 'guardian') {
    // ë³´í˜¸ì ë²ˆí˜¸ë¥¼ ë¯¸ë¦¬ ì§€ì •í•˜ì„¸ìš”
    const guardianPhone = '01012345678';
    window.location.href = `tel:${guardianPhone}`;
  }
}


// renderFriends: DBì—ì„œ ê°€ì ¸ì˜¨ ì¹œêµ¬ ëª©ë¡ì„ í™”ë©´ì— í‘œì‹œ
function renderFriends(friendsList = friends) {
  const container = document.getElementById("friends-list");
  container.innerHTML = "";

  if (!friendsList || friendsList.length === 0) {
    container.innerHTML = "<p>ì¹œêµ¬ê°€ ì—†ìŠµë‹ˆë‹¤.</p>";
    return;
  }

  friendsList.forEach(person => {
    // ì¹´ë“œ ìƒì„±
    const card = document.createElement("div");
    card.className = "friend-card";
    // ê¸°ì¡´ ìŠ¤íƒ€ì¼ + ë‘ ë²ˆì§¸ ì½”ë“œ ìŠ¤íƒ€ì¼ í†µí•©
    card.style.display = "flex";
    card.style.justifyContent = "space-between";
    card.style.alignItems = "center";
    card.style.maxWidth = "600px";
    card.style.border = "1px solid #ccc";
    card.style.borderRadius = "12px";
    card.style.padding = "16px";
    card.style.marginBottom = "12px";
    card.style.backgroundColor = "#fff";
    card.style.boxShadow = "0 2px 6px rgba(0,0,0,0.1)";

    // ì •ë³´ ë°•ìŠ¤
    const infoBox = document.createElement("div");
    infoBox.style.display = "flex";
    infoBox.style.flexDirection = "column";
    infoBox.style.flex = "1";

    const nameEl = document.createElement("h3");
    nameEl.textContent = person.name;
    const categoryEl = document.createElement("div");
    categoryEl.textContent = `ê´€ì‹¬ : ${person.category || person.hobby || "ì¹œêµ¬"}`;
    categoryEl.style.color = "#555";
    const descEl = document.createElement("p");
    descEl.textContent = `ğŸ’¬ ${person.profile_text || "ê°™ì´ í™œë™í•  ì¹œêµ¬ì…ë‹ˆë‹¤."}`;
    descEl.style.fontSize = "14px";
    const phoneBtn = document.createElement("button");
    phoneBtn.textContent = "ì—°ë½í•˜ê¸°";
    phoneBtn.onclick = () => call(person.phone || "010-0000-0000", person.name);

    infoBox.append(nameEl, categoryEl, descEl);
    card.append(infoBox, phoneBtn);
    container.appendChild(card);
  });
}

// 1. ì¹œêµ¬ ëª©ë¡ ë Œë” í•¨ìˆ˜ ì •ì˜ (ì „ì—­)
  async function loadFriends() {
    const res = await fetch("/db/getFriends", { method: "GET", credentials: "include" });
    const container = document.getElementById("friends-list");
    container.innerHTML = "";

    const data = await res.json();
    if (!data.success) return;

    data.friends.forEach(f => {
      const div = document.createElement("div");
      div.textContent = `${f.name} (${f.hobby || ""})`;
      container.appendChild(div);
    });
  }

/* ==================== ì¹œêµ¬ ì°¾ê¸° ==================== */
async function findNearbyFriends() {
  if (!navigator.geolocation) {
    alert("ì´ ë¸Œë¼ìš°ì €ëŠ” ìœ„ì¹˜ ì„œë¹„ìŠ¤ë¥¼ ì§€ì›í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤.");
    return;
  }

  navigator.geolocation.getCurrentPosition(async (pos) => {
    const { latitude, longitude } = pos.coords;

    try {
      // ìœ„ì¹˜ ì—…ë°ì´íŠ¸
      await fetch("/db/updateLocation", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        credentials: "include",
        body: JSON.stringify({ latitude, longitude }),
      });

      // ê·¼ì²˜ ì¹œêµ¬ ê²€ìƒ‰
      const res = await fetch("/db/nearby", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        credentials: "include",
        body: JSON.stringify({ latitude, longitude }),
      });

      const result = await res.json();
      if (!result.success) {
        alert("ì˜¤ë¥˜: " + result.message);
        return;
      }

      const nearbyFriendsFind = result.data;

      // ì„œë²„ì—ì„œ ë°›ì€ ë°ì´í„°ë¡œ friends ë¦¬ìŠ¤íŠ¸ ìƒì„±
      const list = nearbyFriendsFind.map(f => ({
        id: f.id,
        name: f.name || f.id,
        hobby: f.hobby || "ì¹œêµ¬",
        profile_text: `ğŸ’¬ ${f.profile_text || "ê°™ì´ í™œë™í•  ì¹œêµ¬ì…ë‹ˆë‹¤."}`,
        phone: f.phone || "010-0000-0000",
        distance: f.distance
      }));

      // ê¸°ì¡´ renderFriendsFind ìˆ˜ì •: ê±°ë¦¬ í¬í•¨í•´ì„œ í•œ ë²ˆë§Œ ë Œë”
      function renderFriendsFind(list) {
        const container = document.getElementById("friends-find");
        container.innerHTML = ""; // ê¸°ì¡´ ëª©ë¡ ì´ˆê¸°í™”

        if (!list || list.length === 0) {
          container.innerHTML = "<p>ê·¼ì²˜ì— ì¹œêµ¬ê°€ ì—†ìŠµë‹ˆë‹¤.</p>";
          return;
        }

        list.forEach(person => {
          const itemBox = document.createElement("div");
          itemBox.classList.add("person-item");
          itemBox.style.display = "flex"; // flexë¡œ ê°€ë¡œ ë°°ì¹˜
          itemBox.style.justifyContent = "space-between"; // ì™¼ìª½/ì˜¤ë¥¸ìª½ ë‚˜ëˆ„ê¸°
          itemBox.style.alignItems = "center"; // ìˆ˜ì§ ì¤‘ì•™ ì •ë ¬
          itemBox.style.maxWidth = "600px"; // ì¹´ë“œ ìµœëŒ€ ë„“ì´
          itemBox.style.border = "1px solid #ccc";
          itemBox.style.borderRadius = "12px";
          itemBox.style.padding = "16px";
          itemBox.style.marginBottom = "12px";
          itemBox.style.backgroundColor = "#fff";
          itemBox.style.boxShadow = "0 2px 6px rgba(0,0,0,0.1)";

          // ì™¼ìª½ ì •ë³´ ë¬¶ìŒ
          const infoBox = document.createElement("div");
          infoBox.style.display = "flex";
          infoBox.style.flexDirection = "column";
          infoBox.style.flex = "1";           // ê°€ëŠ¥í•œ ê³µê°„ë§Œ ì°¨ì§€
          infoBox.style.maxWidth = "70%";     // ìµœëŒ€ 70%ê¹Œì§€ë§Œ ì°¨ì§€
          infoBox.style.marginRight = "12px"; // ì˜¤ë¥¸ìª½ ë²„íŠ¼ê³¼ ê°„ê²©

          const nameEl = document.createElement("h3");
          nameEl.textContent = person.name;
          nameEl.style.marginBottom = "6px";

          const categoryEl = document.createElement("div");
          categoryEl.textContent = `ê´€ì‹¬: ${person.hobby}`;
          categoryEl.style.color = "#555";
          categoryEl.style.fontSize = "15px";

          const profile_textEl = document.createElement("p");
          profile_textEl.textContent = person.profile_text;
          profile_textEl.style.fontSize = "14px";
          profile_textEl.style.margin = "6px 0";

          const phoneEl = document.createElement("div");
          phoneEl.textContent = `ì—°ë½ì²˜: ${person.phone}`;
          phoneEl.style.fontSize = "14px";
          phoneEl.style.color = "#666";

          // ê±°ë¦¬ í‘œì‹œ í¬í•¨ (í•œ ë²ˆë§Œ)
          const distanceEl = document.createElement("div");
          distanceEl.textContent = `ê±°ë¦¬: ${Number(person.distance).toFixed(2)} km`;
          distanceEl.style.fontSize = "16px";
          distanceEl.style.marginTop = "8px";
          distanceEl.style.fontWeight = "bold";
          distanceEl.style.color = "#2c7";

          // ğŸ”¹ ì¹œêµ¬ ì¶”ê°€ ë²„íŠ¼
          const addBtn = document.createElement("button");
          addBtn.textContent = "â• ì¹œêµ¬ ìš”ì²­";
          addBtn.style.marginTop = "10px";
          addBtn.style.padding = "8px 14px";
          addBtn.style.borderRadius = "8px";
          addBtn.style.backgroundColor = "#00796B";
          addBtn.style.color = "#fff";
          addBtn.style.border = "none";
          addBtn.style.cursor = "pointer";

          const loggedInUserId = localStorage.getItem("loggedInUser");

          // ğŸ”¹ ë²„íŠ¼ í´ë¦­ ì‹œ ì¹œêµ¬ ì¶”ê°€
          addBtn.addEventListener("click", async () => {
  const confirmAdd = confirm(`${person.name}ë‹˜ì—ê²Œ ì¹œêµ¬ ìš”ì²­ì„ ë³´ë‚´ì‹œê² ìŠµë‹ˆê¹Œ?`);
  if (!confirmAdd) return;

  try {
    const response = await fetch("/db/addFriend", { // ì´ë¯¸ dbRouter.jsì—ì„œ ì¹œêµ¬ ìš”ì²­ ì „ì†¡ ë¡œì§ìœ¼ë¡œ ë°”ê¿¨ë‹¤ê³  ê°€ì •
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({ friendId: person.id }),
      credentials: "include" 
    });

    const data = await response.json();
    console.log("ì¹œêµ¬ ìš”ì²­ ì „ì†¡ response:", data);

    if (response.ok && data.success) {
      alert("ì¹œêµ¬ ìš”ì²­ì„ ë³´ëƒˆìŠµë‹ˆë‹¤!");
      addBtn.disabled = true;
      addBtn.textContent = "ìš”ì²­ ì™„ë£Œ";
      addBtn.style.backgroundColor = "gray";
    } else {
      alert(data.message || "ì¹œêµ¬ ìš”ì²­ ì‹¤íŒ¨");
    }
  } catch (err) {
    console.error(err);
    alert("ì¹œêµ¬ ìš”ì²­ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.");
  }
});

          // ì¹´ë“œì— ëª¨ë‘ ì¶”ê°€
          infoBox.appendChild(nameEl);
          infoBox.appendChild(categoryEl);
          infoBox.appendChild(profile_textEl);
          infoBox.appendChild(phoneEl);
          infoBox.appendChild(distanceEl);

          itemBox.appendChild(infoBox);  // ì™¼ìª½ ì •ë³´
          itemBox.appendChild(addBtn);   // ì˜¤ë¥¸ìª½ ë²„íŠ¼

          container.appendChild(itemBox);
        });
      }

      // ë Œë”ë§
      renderFriendsFind(list);

      // show í˜¸ì¶œ ì „ì— suppressFriendsRender í”Œë˜ê·¸ ì„¤ì •
      suppressFriendsRender = true;
      show("friendsfind");

    } catch (err) {
      console.error(err);
      alert("ê·¼ì²˜ ì¹œêµ¬ ì¡°íšŒ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.");
    }
  }, (err) => {
    console.error(err);
    alert("ìœ„ì¹˜ ì •ë³´ë¥¼ ê°€ì ¸ì˜¤ëŠ” ë° ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.");
  });
}

document.getElementById("FriendrequestBtn").addEventListener("click", async () => {
  show("friendsfind"); // ìš”ì²­ ëª©ë¡ì„ ê°™ì€ UI ì„¹ì…˜ ì¬ì‚¬ìš©
  const container = document.getElementById("friends-find");
  container.innerHTML = "<p>ìš”ì²­ ëª©ë¡ì„ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...</p>";

  const res = await fetch("/db/getFriendRequests", { method: "GET", credentials: "include" });
  const data = await res.json();
  if (!data.success) return alert("ë¶ˆëŸ¬ì˜¤ê¸° ì‹¤íŒ¨");

  container.innerHTML = "";
  if (data.requests.length === 0) {
    container.innerHTML = "<p>ë°›ì€ ì¹œêµ¬ ìš”ì²­ì´ ì—†ìŠµë‹ˆë‹¤.</p>";
    return;
  }

  data.requests.forEach(req => {
    const card = document.createElement("div");
    card.className = "friend-card";
    card.innerHTML = `
      <div class="friend-name">${req.name}</div>
      <div>ê´€ì‹¬: ${req.hobby || "ì •ë³´ ì—†ìŒ"}</div>
      <div>${req.profile_text || ""}</div>
      <button class="accept-btn">âœ… ìˆ˜ë½</button>
    `;

    // ìˆ˜ë½ ë²„íŠ¼ í´ë¦­
    card.querySelector(".accept-btn").onclick = async () => {
      try {
        const res2 = await fetch("/db/acceptFriendRequest", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          credentials: "include",
          body: JSON.stringify({ from_id: req.from_id }),
        });
        const data2 = await res2.json();

        if (data2.success) {
          alert(`${req.name}ë‹˜ê³¼ ì¹œêµ¬ê°€ ë˜ì—ˆìŠµë‹ˆë‹¤!`);
          card.remove();

          // ì¹œêµ¬ ëª©ë¡ ìƒˆë¡œê³ ì¹¨
          loadFriends();
        } else alert("ìˆ˜ë½ ì‹¤íŒ¨: " + data2.message);
      } catch (err) {
        console.error(err);
        alert("ìˆ˜ë½ ì¤‘ ì˜¤ë¥˜ ë°œìƒ");
      }
    };

    container.appendChild(card);
  });
});

/* ==================== UI í•¨ìˆ˜ ==================== */
// ====== ì‹œì¥ ì§€ë„ìš© ì „ì—­ ë³€ìˆ˜ ì„ ì–¸ (ë°˜ë“œì‹œ ì¶”ê°€) ======
let map2, ps, myPosition;
let markers = [];
let selectedMarker = null;
let activeItem = null;

// âœ… DOM ìš”ì†Œ ì—°ê²° (ëª©ë¡ / ì‚¬ì´ë“œë°” / ìƒì„¸ë³´ê¸° íŒ¨ë„)
const sidebarEl = document.getElementById("sidebar");
const listBoxEl = document.getElementById("list-box");
const detailEl = document.getElementById("detail-panel");
const containerEl = document.getElementById("container");

function initMarketMap() {
  if (navigator.geolocation) {
    navigator.geolocation.getCurrentPosition(
      (position) => {
        const lat = 35.150534555935;
        const lng = 126.91606603466;
        initMap2(lat, lng);
      },
      () => {
        alert("í˜„ì¬ ìœ„ì¹˜ë¥¼ ë¶ˆëŸ¬ì˜¬ ìˆ˜ ì—†ì–´ ê¸°ë³¸ ìœ„ì¹˜ë¡œ ì„¤ì •í•©ë‹ˆë‹¤.");
        initMap2(35.150534555935, 126.91606603466);
      },
      {
        enableHighAccuracy: true, // GPS/WiFi ëª¨ë‘ ì‚¬ìš©
        timeout: 10000,           // 10ì´ˆ ë‚´ ì‘ë‹µ
        maximumAge: 0             // ìºì‹œ ì‚¬ìš© ì•ˆí•¨
      }
    );
  } else {
    alert("ì´ ë¸Œë¼ìš°ì €ëŠ” ìœ„ì¹˜ ì„œë¹„ìŠ¤ë¥¼ ì§€ì›í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤.");
    initMap2(35.1468, 126.9226);
  }
}
// âœ… ë§ˆì»¤ ì „ì—­ ë³€ìˆ˜ ì„ ì–¸ (ì§€ë„ ë§ˆì»¤ ì•„ì´ì½˜ ì´ë¯¸ì§€)
let markerNormal;
let markerSelected;


function initMap2(lat, lng) {
  const mapContainer = document.getElementById('marketMap');
  const opt = { center: new kakao.maps.LatLng(lat, lng), level: 4 };
  map2 = new kakao.maps.Map(mapContainer, opt);
  ps  = new kakao.maps.services.Places();
  myPosition = new kakao.maps.LatLng(lat, lng);

  const myMarker = new kakao.maps.Marker({ map: map2, position: myPosition });
  new kakao.maps.InfoWindow({ content: '<div style="padding:3px 5px; font-size:12px;">ğŸ“ í˜„ì¬ ë‚´ ìœ„ì¹˜</div>'}).open(map2, myMarker);

  // âœ… ì§€ë„ í‘œì‹œê°€ ì•ˆë  ë•Œ ê¼­ ì¶”ê°€í•´ì•¼ í•˜ëŠ” ë¶€ë¶„
  setTimeout(() => {
    map2.relayout();                 // ì§€ë„ì˜ ë ˆì´ì•„ì›ƒ ì¬ì¡°ì •
    map2.setCenter(myPosition);      // ì¤‘ì‹¬ì¢Œí‘œ ë‹¤ì‹œ ì§€ì •
  }, 300); // 0.3ì´ˆ í›„ ì‹¤í–‰
}

// ê²€ìƒ‰
document.getElementById('marketSearchBtn').addEventListener('click', () => {
  const keyword = document.getElementById('marketKeyword').value.trim();
  if (!keyword) { alert('ê²€ìƒ‰ì–´ë¥¼ ì…ë ¥í•˜ì„¸ìš”!'); return; }
  containerEl.classList.add('with-panels');
  searchNearby(keyword);
});

function searchNearby(keyword) {
  if (!myPosition) { alert('ìœ„ì¹˜ ì •ë³´ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘ì…ë‹ˆë‹¤.'); return; }
  ps.keywordSearch(keyword, placesSearchCB, { location: myPosition, radius: 20000 });
}

function placesSearchCB(data, status) {
  if (status !== kakao.maps.services.Status.OK) {
    listBoxEl.innerHTML = '<p>ê²€ìƒ‰ ê²°ê³¼ê°€ ì—†ìŠµë‹ˆë‹¤.</p>';
    return;
  }
  sidebarEl.style.display = 'block';
  clearMarkers();
  listBoxEl.innerHTML = '';
  detailEl.classList.remove('show');
  detailEl.innerHTML = '';

  const bounds = new kakao.maps.LatLngBounds();
  data.forEach(place => {
    const marker = createMarker(place);
    appendListItem(place, marker);
    bounds.extend(new kakao.maps.LatLng(place.y, place.x));
  });
  map2.setBounds(bounds);
}

function createMarker(place) {
  const marker = new kakao.maps.Marker({
    map: map2,
    position: new kakao.maps.LatLng(place.y, place.x),
    image: markerNormal
  });
  kakao.maps.event.addListener(marker, 'click', () => selectMarker(marker, place));
  markers.push(marker);
  return marker;
}

function selectMarker(marker, place) {
  if (selectedMarker && selectedMarker !== marker)
    selectedMarker.setImage(markerNormal);
  marker.setImage(markerSelected);
  selectedMarker = marker;
  const pos = new kakao.maps.LatLng(place.y, place.x);
  map2.panTo(pos);
  if (map2.getLevel() > 3) map2.setLevel(3, { animate: { duration: 400 } });
  showDetail(place);
}

function appendListItem(place, marker) {
  const item = document.createElement('div');
  item.className = 'place-item';
  item.style = 'background:#fafafa;border-radius:10px;padding:12px;margin-bottom:8px;cursor:pointer;';
  item.innerHTML = `<div style="color:#00796B;font-weight:700;">${place.place_name}</div>
                    <div style="color:#555;">${place.address_name}</div>`;
  item.addEventListener('click', () => {
    if (activeItem) activeItem.style.background = '#fafafa';
    item.style.background = '#c8f7e8';
    activeItem = item;
    selectMarker(marker, place);
  });
  listBoxEl.appendChild(item);
}

function showDetail(place) {
  const rating = (Math.random()*1.5 + 3.5).toFixed(1);
  const reviews = Math.floor(Math.random()*400) + 50;
  detailEl.style.display = 'block';
  detailEl.innerHTML = `
    <h2 style="color:#00796B;">${place.place_name}</h2>
    <div style="color:#FFD700;">â­ ${rating} / 5.0 (${reviews}ëª… ë¦¬ë·°)</div>
    <p>ğŸ“Œ ${place.address_name}</p>
    ${place.phone ? `<p>ğŸ“ ${place.phone}</p>` : ''}
    ${place.category_name ? `<p>ğŸ· ${place.category_name}</p>` : ''}
    <button id="close-detail" style="margin-top:10px;padding:8px 14px;border:0;border-radius:8px;background:#00796B;color:#fff;cursor:pointer;">ë‹«ê¸°</button>`;
  document.getElementById('close-detail').addEventListener('click', () => {
    detailEl.style.display = 'none';
    if (activeItem) activeItem.style.background = '#fafafa';
  });
}

function clearMarkers() {
  markers.forEach(m => m.setMap(null));
  markers = []; selectedMarker = null;
}



/* ==================== ë‹¬ë ¥ ==================== */
async function renderSchedule() {
  const calendarGrid = document.getElementById('calendar-grid');
  calendarGrid.innerHTML = '';
  const year = 2025, month = 9; // 10ì›”
  const today = new Date();
  const firstDay = new Date(year, month, 1).getDay();
  const daysInMonth = new Date(year, month + 1, 0).getDate();

  // ë¹ˆ ì¹¸ ì±„ìš°ê¸°
  for (let i = 0; i < firstDay; i++) {
    calendarGrid.innerHTML += '<div class="calendar-day empty"></div>';
  }

  // Firestoreì—ì„œ ì¼ì • ë¶ˆëŸ¬ì˜¤ê¸°
  const snapshot = await db.collection("events")
    .where("date", ">=", `${year}-${month+1}-01`)
    .where("date", "<=", `${year}-${month+1}-${daysInMonth}`)
    .get();

  const eventsByDay = {};
  snapshot.forEach(doc => {
    const e = doc.data();
    const day = parseInt(e.date.split("-")[2]);
    if (!eventsByDay[day]) eventsByDay[day] = [];
    eventsByDay[day].push(e);
  });

  // ë‚ ì§œë³„ ë‹¬ë ¥ ìƒì„±
  for (let day = 1; day <= daysInMonth; day++) {
    const dayDiv = document.createElement('div');
    dayDiv.className = 'calendar-day';

    if (day === today.getDate() && month === today.getMonth() && year === today.getFullYear()) {
      dayDiv.classList.add('today');
    }

    let html = `<div class="day-number">${day}</div>`;

    // ğŸ”” ì¼ì • + ë²„íŠ¼ í‘œì‹œ
    if (eventsByDay[day]) {
      eventsByDay[day].forEach(ev => {
        html += `
          <div class="day-event">
            ${ev.title}${ev.details ? ` - ${ev.details}` : ''}
            <button class="alert-btn" onclick="addAlert('${ev.title}', '${ev.date}', '${ev.time || ''}')">ğŸ”” ì•Œë¦¼ ì¶”ê°€</button>
          </div>
        `;
      });
    }

    dayDiv.innerHTML = html;
    calendarGrid.appendChild(dayDiv);

    // ë‚ ì§œ í´ë¦­ ì‹œ ì¼ì • ì¶”ê°€ íŒì—…
    dayDiv.addEventListener("click", () => openAddEventPopup(`${year}-${month+1}-${day}`));
  }
}

// ğŸ”” ì•Œë¦¼ ì„¹ì…˜ì— ì¼ì • ì¶”ê°€
function addAlert(title, date, time) {
    const alertList = document.querySelector("#alerts ul");

    // Firestore ì¼ì •ì²˜ëŸ¼ Date ê°ì²´ë¡œ ë³€í™˜
    const eventTime = new Date(`${date}T${time || "00:00"}`); // time ì—†ìœ¼ë©´ 00:00

    const month = eventTime.getMonth() + 1;
    const day = eventTime.getDate();
    const hours = eventTime.getHours().toString().padStart(2, "0");
    const minutes = eventTime.getMinutes().toString().padStart(2, "0");

    const formattedTime = `${month}ì›” ${day}ì¼ ${hours}:${minutes}ë¶„`;

    const li = document.createElement("li");
    li.textContent = `${formattedTime} - ${title}`;
    alertList.appendChild(li);

    alert(`${title} ì¼ì •ì´ ì•Œë¦¼ ëª©ë¡ì— ì¶”ê°€ë˜ì—ˆìŠµë‹ˆë‹¤.`);
}

/* ==================== ë¡œê·¸ì¸ / ì´ˆê¸°í™” ==================== */
function initializeMainApp() {
  renderSchedule();
  renderFriends();
}

/* ==================== ì´ë²¤íŠ¸ ë“±ë¡ ==================== */
document.addEventListener("DOMContentLoaded", () => {
  // í—¤ë” í´ë¦­ â†’ í™ˆìœ¼ë¡œ
  document.querySelector('.header-title').onclick = () => show('home');
  
  document.querySelector('#alarm-icon').onclick = () => show('alerts');

  // í•˜ë‹¨ ë©”ë‰´ í´ë¦­ ì´ë²¤íŠ¸ ë“±ë¡
  document.querySelectorAll('.nav-btn').forEach(btn => {
    btn.addEventListener('click', () => {
      const target = btn.dataset.target;
      show(target);
    });
  });
});

/* ==================== ì „í™” ==================== */
function call(phone, name) {
  alert(`${name}ë‹˜ê³¼ ì—°ê²°ì„ ì‹œë„í•©ë‹ˆë‹¤.\n${phone}`);
  window.location.href = `tel:${phone}`;
}
</script>

 <!-- âœ… Firebase SDK ì¶”ê°€ -->
<script src="https://www.gstatic.com/firebasejs/10.12.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.12.0/firebase-firestore-compat.js"></script>

<script>
// âœ… Firebase ì´ˆê¸°í™”
const firebaseConfig = {
  apiKey: "AIzaSyCRcveuTZCzVS9wSfBU4j0oUtayypqmVF8",
  authDomain: "vitamind-senior.firebaseapp.com",
  projectId: "vitamind-senior",
  storageBucket: "vitamind-senior.firebasestorage.app",
  messagingSenderId: "1051160585043",
  appId: "1:1051160585043:web:676e5f3087addf4972b7a6",
  measurementId: "G-RB8Q4GWLPS"
};
const app = firebase.initializeApp(firebaseConfig);
const db = firebase.firestore();

// âœ… Firestore ì¼ì • ì‹¤ì‹œê°„ ê°ì‹œ ë° ì•Œë¦¼ ê¸°ëŠ¥
function startEventAlertListener() {
  const alertBefore = parseInt(localStorage.getItem("alertBefore") || "10"); // ê¸°ë³¸ 10ë¶„ ì „
  db.collection("events").onSnapshot(snapshot => {
    const now = new Date();
    const future = new Date(now.getTime() + alertBefore * 60000);

    snapshot.forEach(doc => {
      const e = doc.data();
      const eventTime = new Date(`${e.date}T${e.time}`);

      if (eventTime > now && eventTime <= future) {
        const key = `notified_${doc.id}`;
        if (!localStorage.getItem(key)) {
          localStorage.setItem(key, "true");
          alert(`ğŸ”” ${e.title} ì¼ì •ì´ ê³§ ì‹œì‘ë©ë‹ˆë‹¤!\n(${e.time}, ${alertBefore}ë¶„ ì „)`);

                  // ë¸Œë¼ìš°ì € ì•Œë¦¼ (í—ˆìš©ëœ ê²½ìš°)
          if (Notification.permission === "granted") {
            new Notification(`ğŸ”” ${e.title}`, {
              body: `${alertBefore}ë¶„ í›„ ì‹œì‘ (${e.time})`,
              icon: "https://cdn-icons-png.flaticon.com/512/190/190411.png"
            });
          }
        }
      }
    });
  });
}

// âœ… Firestore ì¼ì • ëª©ë¡ í‘œì‹œ (ë‹¬ë ¥ ë°‘ì— ë¶™ì—¬ í‘œì‹œ)
async function renderEventListFromFirestore() {
  const container = document.createElement("div");
  container.id = "firestoreEventList";
  container.style = `
    margin-top:40px;
    background:#fff;
    border-radius:15px;
    padding:25px;
    font-size:28px;
    line-height:1.6;
  `;
  document.querySelector("#schedule")?.appendChild(container);

  const snap = await db.collection("events").orderBy("date", "asc").get();
  const now = new Date();
  let html = "";

  for (const doc of snap.docs) {
  const e = doc.data();
  const eventTime = new Date(`${e.date}T${e.time}`);
  if (eventTime < now) {
    await db.collection("events").doc(doc.id).delete(); // ì§€ë‚œ ì¼ì • ìë™ì‚­ì œ
    continue;
  }

  // ì›í•˜ëŠ” í˜•ì‹ìœ¼ë¡œ ë‚ ì§œ í¬ë§·íŒ…
  const month = eventTime.getMonth() + 1; // getMonth()ëŠ” 0~11
  const day = eventTime.getDate();
  const hours = eventTime.getHours();
  const minutes = eventTime.getMinutes().toString().padStart(2, "0"); // í•œ ìë¦¬ì¼ ë•Œ 0 ë¶™ì´ê¸°
  const formattedTime = `${month}ì›” ${day}ì¼ ${hours}:${minutes}ë¶„`;

  html += `
    <div style="border-bottom:1px solid #ccc; padding:8px 0;">
      <strong>${e.title}</strong> (${formattedTime})<br>
      <span style="color:#555;">${e.details || "(ì„¸ë¶€ë‚´ìš© ì—†ìŒ)"}</span>
      <div style="font-size:22px; color:#777;">ì‘ì„±ì: ${e.owner}</div>
    </div>`;
}
 container.innerHTML = `
    <h3 style="font-size:34px; margin-bottom:15px;">ğŸ“‹ ì¼ì • ëª©ë¡</h3>
    ${html || "<p>ë“±ë¡ëœ ì¼ì •ì´ ì—†ìŠµë‹ˆë‹¤.</p>"}
  `;
}
// âœ… ë¸Œë¼ìš°ì € ì•Œë¦¼ ê¶Œí•œ ìš”ì²­
document.addEventListener("DOMContentLoaded", () => {
  if (Notification && Notification.permission !== "granted") {
    Notification.requestPermission();
  }
  startEventAlertListener();
  renderEventListFromFirestore();
});

// í•˜ë‹¨ ë„¤ë¹„ê²Œì´ì…˜ ë²„íŠ¼ì— ì´ë²¤íŠ¸ ì¶”ê°€
document.querySelector(".nav-btn[data-target='friendsfind']")
  .addEventListener("click", () => {
    findNearbyFriends(); // ê·¼ì²˜ ì¹œêµ¬ ì°¾ê¸° í•¨ìˆ˜ í˜¸ì¶œ
  });
</script>

<script>
window.addEventListener('DOMContentLoaded', () => {
  // URLì— #scheduleì´ ë¶™ì–´ìˆëŠ” ê²½ìš°
  if (window.location.hash === '#schedule') {
    show('schedule'); // ì´ë¯¸ ì •ì˜ëœ show() í•¨ìˆ˜ ì´ìš©
  }
});

/* ==================== ì¥ë³´ê¸°(ì‹œì¥, ë³µì§€ê´€) ì§€ë„ ê¸°ëŠ¥ ==================== */
// map2, psëŠ” ì´ë¯¸ ì „ì—­ì—ì„œ ì •ì˜ë˜ì–´ ìˆë‹¤ê³  ê°€ì •
let infowindow; // ì¸í¬ìœˆë„ìš°ë§Œ ìƒˆë¡œ ì„ ì–¸

window.addEventListener("DOMContentLoaded", () => {
  // âœ… ì§€ë„ ì´ˆê¸°í™”
  const mapContainer = document.getElementById('marketMap');
  if (mapContainer) {
    const centerPos = new kakao.maps.LatLng(35.1515, 126.9091); // ì´ˆê¸° ìœ„ì¹˜
    const mapOption = { center: centerPos, level: 5 };
    if (!map2) map2 = new kakao.maps.Map(mapContainer, mapOption);

    if (!ps) ps = new kakao.maps.services.Places();
    infowindow = new kakao.maps.InfoWindow({ zIndex: 1 });
  }

  // âœ… ê²€ìƒ‰ ë²„íŠ¼ ì´ë²¤íŠ¸ ë“±ë¡
  const searchBtn = document.getElementById("marketSearchBtn");
  if (searchBtn) {
    searchBtn.addEventListener("click", searchMarketPlaces);
  }
});

// âœ… ì¥ì†Œ ê²€ìƒ‰ í•¨ìˆ˜
function searchMarketPlaces() {
  const keywordInput = document.getElementById('marketKeyword');
  const keyword = keywordInput ? keywordInput.value.trim() : '';
  if (!keyword) {
    alert("ê²€ìƒ‰ì–´ë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”.");
    return;
  }

  const listBox = document.getElementById("list-box");
  if (listBox) listBox.innerHTML = "<p>ìœ„ì¹˜ ì •ë³´ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘ì…ë‹ˆë‹¤...</p>";

  // ğŸ‘‡ğŸ‘‡ğŸ‘‡ ì¶”ê°€: ì‚¬ì´ë“œë°” ë³´ì´ê²Œ
  if (typeof sidebarEl !== 'undefined' && sidebarEl) {
    sidebarEl.style.display = 'block';
  }
  if (typeof detailEl !== 'undefined' && detailEl) {
    detailEl.style.display = 'none';
  }

  if (navigator.geolocation) {
    navigator.geolocation.getCurrentPosition(pos => {
      const userLoc = new kakao.maps.LatLng(pos.coords.latitude, pos.coords.longitude);
      if (map2) map2.setCenter(userLoc);
      if (ps) ps.keywordSearch(keyword, placesSearchCB, { location: userLoc });
    }, () => {
      if (ps) ps.keywordSearch(keyword, placesSearchCB);
    });
  } else {
    if (ps) ps.keywordSearch(keyword, placesSearchCB);
  }
}

// ===== rasp api ê¸°ë³¸ì£¼ì†Œ =====
// 1) ìš°ì„  localStorage('rasp_base') ì‚¬ìš©. ì—†ìœ¼ë©´ ì•„ë˜ ê¸°ë³¸ê°’ ì‚¬ìš©.
// 2) ngrok urlë¡œ ë°”ê¿”ì„œ ì“°ì. ì˜ˆ: https://xxxxx.ngrok-free.dev
// ê°™ì€ ì˜¤ë¦¬ì§„ í”„ë¡ì‹œë¡œ ê³ ì •
let rasp_base = localStorage.getItem('rasp_base') || (location.origin + '/rapi');

// ===== í—¬í¼: rasp_base ì €ì¥ =====
// ì…ë ¥: url ë¬¸ìì—´
function set_rasp_base(url) {
  // ê³µë°± ì œê±°. // ì¤‘ë³µ ìŠ¬ë˜ì‹œ ì œê±°.
  const clean = (url || '').trim().replace(/\/+$/,'');
  if (!clean) return;
  rasp_base = clean;
  localStorage.setItem('rasp_base', clean);
}

// ===== í—¬í¼: url ë¹Œë“œ =====
// ì…ë ¥: ê²½ë¡œ. ì˜ˆ: '/dht'
function build_url(path) {
  const base = (rasp_base || '').replace(/\/+$/, '') + '/';
  const rel  = String(path || '').replace(/^\/+/, '');
  const u = new URL(base + rel);
  return u.toString(); // ngrok ì¿¼ë¦¬ ì œê±°
}

// ===== í—¬í¼: json fetch =====
// ì‹¤íŒ¨ ì‹œ ì—ëŸ¬ throw. content-type ì ê²€.
async function fetch_json(url) {
  const r = await fetch(url, {
    cache: 'no-store'
  });
  const ct = r.headers.get('content-type') || '';
  if (!r.ok) {
    const text = await r.text();
    throw new Error(`http ${r.status} ${r.statusText}: ${text.slice(0,120)}`);
  }
  if (!ct.includes('application/json')) {
    const text = await r.text();
    throw new Error(`json not returned (ct=${ct}): ${text.slice(0,120)}`);
  }
  return r.json();
}

// ===== í‘œí˜„ì‹: ë”ìœ„ ë¬¸êµ¬ =====
// ì…ë ¥: ì„­ì”¨. ì¶œë ¥: í•œ ì¤„ ë¬¸êµ¬.
function heat_phrase(tc) {
  const t = Number(tc);
  if (isNaN(t)) return 'ë‚ ì”¨ ì •ë³´ë¥¼ í™•ì¸ ì¤‘';
  if (t >= 29) return 'ì˜¤ëŠ˜ì€ ë§ì´ ë¥ìŠµë‹ˆë‹¤';
  if (t >= 25) return 'ì˜¤ëŠ˜ì€ ë¥ìŠµë‹ˆë‹¤';
  if (t >= 18) return 'ì˜¤ëŠ˜ì€ ì„ ì„ í•©ë‹ˆë‹¤';
  if (t >= 5)  return 'ì˜¤ëŠ˜ì€ ìŒ€ìŒ€í•©ë‹ˆë‹¤';
  return 'ì˜¤ëŠ˜ì€ ë§¤ìš° ì¶¥ìŠµë‹ˆë‹¤';
}

// ===== ë Œë”: ë°°ë„ˆ/GPS/PIR =====
// ì…ë ¥: dht, sensor, gps json
function render_sensors(dht, sensor, gps) {
  // dht ë°°ë„ˆ
  const banner = document.getElementById('dht-banner');
  if (banner) {
    const tc = (dht?.temperature_c ?? dht?.temp_c ?? '-');
    const hu = (dht?.humidity_pct ?? dht?.humidity ?? '-');
    const line = `${heat_phrase(tc)} (ğŸŒ¡ ${tc}Â°C Â· ğŸ’§ ${hu}%)`;
    banner.textContent = line;
  }

  // gps ë±ƒì§€
  const gpsBadge = document.getElementById('gps-badge');
  if (gpsBadge) {
    if (gps?.ok && typeof gps.lat === 'number' && typeof gps.lon === 'number') {
      // ì†Œìˆ˜ 6ìë¦¬ ê³ ì •.
      gpsBadge.textContent = `ğŸ“ ${gps.lat.toFixed(6)}, ${gps.lon.toFixed(6)}`;
    } else {
      gpsBadge.textContent = 'ğŸ“ gps ëŒ€ê¸°';
    }
  }

  // pir ì ë“±
  const pirDot = document.getElementById('pir-dot');
  if (pirDot) {
    const on = Number(sensor?.pir) === 1;
    pirDot.style.background = on ? '#d32f2f' : '#2e7d32'; // on=red, off=green
  }
}

// ===== í´ë§ 1íšŒ =====
// ì„±ê³µ: render í˜¸ì¶œ. ì‹¤íŒ¨: ë°°ë„ˆì— ê²½ê³ .
async function refresh_sensors_once() {
  try {
    // ìƒíƒœ ì ê²€
    await fetch_json(build_url('/health'));

    // ë³‘ë ¬ í˜¸ì¶œ: dht/sensor/gps
    const [dht, sensor, gps] = await Promise.all([
      fetch_json(build_url('/dht')),
      fetch_json(build_url('/sensor')),
      fetch_json(build_url('/gps'))
    ]);

    render_sensors(dht, sensor, gps);
  } catch (e) {
    const banner = document.getElementById('dht-banner');
    if (banner) banner.textContent = `ì„¼ì„œ í†µì‹  ì˜¤ë¥˜: ${e.message}`;
  }
}

// ===== í´ë§ ì‹œì‘ =====
// í˜ì´ì§€ ë¡œë“œ í›„ ìë™ ì‹œì‘. 2ì´ˆ ê°„ê²©.
let _sensor_timer = null;
function start_sensor_poll() {
  if (_sensor_timer) clearInterval(_sensor_timer);
  refresh_sensors_once();
  _sensor_timer = setInterval(refresh_sensors_once, 2000);
}

// ===== ë¶€íŒ… =====
document.addEventListener('DOMContentLoaded', () => {
  // í•„ìš”í•˜ë©´ í•œ ë²ˆë§Œ ì„¤ì •. ì˜ˆ) set_rasp_base('https://xxxxx.ngrok-free.dev');
  start_sensor_poll();
});

// ===== sim api base =====
// ëª©ì : ì„œë²„ì˜ ì‹œë®¬ë ˆì´í„° ìƒíƒœ í´ë§.
// ì—”ë“œí¬ì¸íŠ¸: /sim/state, /sim/log, /sim/mock/*, /sim/reset
const sim_base = '';

async function sim_get_json(p) {
  const r = await fetch(sim_base + p, { credentials:'include' });
  if (!r.ok) throw new Error('http ' + r.status);
  return r.json();
}
async function sim_post_json(p, body={}) {
  const r = await fetch(sim_base + p, {
    method:'POST',
    headers:{ 'content-type':'application/json' },
    credentials:'include',
    body: JSON.stringify(body)
  });
  if (!r.ok) throw new Error('http ' + r.status);
  return r.json();
}

function render_sim(state) {
  const banner = document.getElementById('sim-alert-banner');
  if (!banner) return;
  const inwin = state.data.in_window;
  const alerting = state.data.alerting;
  const last = state.data.last_alert_at;
  banner.style.display = 'block';
  if (!inwin) {
    banner.style.background = '#e0f7fa';
    banner.style.borderColor = '#26c6da';
    banner.style.color = '#006064';
    banner.textContent = 'ê°ì‹œ ì‹œê°„ëŒ€ ì•„ë‹˜ (09~22ì‹œ)';
    return;
  }
  if (alerting) {
    banner.style.background = '#ffe0e0';
    banner.style.borderColor = '#ff5252';
    banner.style.color = '#b00020';
    banner.textContent = (last ? `ë¬´ë™ì‘ ê²½ë³´ ë°œìƒ(ì‹œë®¬ë ˆì´ì…˜). ì—°ë½ ì™„ë£Œ ì²˜ë¦¬ë¨: ${last}` : 'ë¬´ë™ì‘ ê²½ë³´ ë°œìƒ(ì‹œë®¬ë ˆì´ì…˜). ì—°ë½ ì™„ë£Œ ì²˜ë¦¬ë¨.');
  } else {
    banner.style.background = '#e8f5e9';
    banner.style.borderColor = '#66bb6a';
    banner.style.color = '#1b5e20';
    banner.textContent = 'ì •ìƒ. ë¬´ë™ì‘ ê²½ë³´ ì—†ìŒ';
  }
}

async function sim_refresh_once() {
  try {
    const s = await sim_get_json('/sim/state');
    render_sim(s);
  } catch (e) {
    const banner = document.getElementById('sim-alert-banner');
    if (banner) {
      banner.style.display = 'block';
      banner.style.background = '#fff3cd';
      banner.style.borderColor = '#ffecb5';
      banner.style.color = '#7f6f00';
      banner.textContent = 'ì‹œë®¬ë ˆì´í„° ì—°ê²° ëŒ€ê¸°';
    }
  }
}

let sim_timer = null;
function sim_start_poll() {
  if (sim_timer) clearInterval(sim_timer);
  sim_refresh_once();
  sim_timer = setInterval(sim_refresh_once, 5000);
}

// ë²„íŠ¼ í•¸ë“¤ëŸ¬
document.getElementById('sim-ack')?.addEventListener('click', async () => {
  try { await sim_post_json('/sim/reset'); await sim_refresh_once(); } catch(e){ alert(e.message); }
});
document.getElementById('sim-mock-alert')?.addEventListener('click', async () => {
  try { await sim_post_json('/sim/mock/alert'); await sim_refresh_once(); } catch(e){ alert(e.message); }
});
document.getElementById('sim-mock-motion')?.addEventListener('click', async () => {
  try { await sim_post_json('/sim/mock/motion'); await sim_refresh_once(); } catch(e){ alert(e.message); }
});
document.getElementById('sim-log-open')?.addEventListener('click', async () => {
  const pre = document.getElementById('sim-log');
  if (!pre) return;
  if (pre.style.display === 'none') {
    try { 
      const js = await sim_get_json('/sim/log'); 
      pre.textContent = js.data.map(x => `[${x.ts}] ${x.type} | ${x.msg}`).join('\n');
      pre.style.display = 'block';
    } catch(e){ alert(e.message); }
  } else {
    pre.style.display = 'none';
  }
});

// ë¶€íŒ…
document.addEventListener('DOMContentLoaded', () => {
  sim_start_poll(); // ìë™ í´ë§ ì‹œì‘
});
</script>
</body>
</html>