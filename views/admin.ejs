<!-- src/views/admin.ejs -->
<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <title>관리자 대시보드</title>
  <link rel="stylesheet" href="/static/admin.css" />
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <style>
    /* 혹시 admin.css 없을 때 최소 레이아웃 */
    body{font-family:system-ui,apple sd gothic neo,Segoe UI,Roboto,'Noto Sans KR',sans-serif;margin:0;background:#fafafa}
    .wrap{max-width:1200px;margin:0 auto;padding:24px}
    .topbar{display:flex;justify-content:space-between;align-items:center;margin-bottom:18px}
    .cards{display:grid;grid-template-columns:repeat(4,1fr);gap:12px}
    .card{background:#fff;border:1px solid #eee;border-radius:12px;padding:18px}
    .num{font-size:32px;font-weight:700}
    .grid{display:grid;grid-template-columns:1fr 1fr 1fr;gap:12px;margin-top:16px}
    .panel{background:#fff;border:1px solid #eee;border-radius:12px;padding:16px}
    table{width:100%;border-collapse:collapse}
    th,td{border-bottom:1px solid #f0f0f0;padding:8px 10px;text-align:left}
    @media (max-width:1080px){.cards{grid-template-columns:repeat(2,1fr)}.grid{grid-template-columns:1fr}}
  </style>
</head>
<body>
  <div class="wrap">
    <div class="topbar">
      <div style="font-weight:700">VitaMind</div>
      <div>
        <a href="/me">내 대시보드</a>
        <a href="/main.html" style="margin-left:12px">로그아웃</a>
      </div>
    </div>

    <h1 style="margin:8px 0 16px">관리자 대시보드</h1>

    <section class="cards">
      <div class="card">
        <div>전체 회원</div>
        <div class="num" id="card-total">0</div>
      </div>
      <div class="card">
        <div>금일 가입</div>
        <div class="num" id="card-signup">0</div>
      </div>
      <div class="card">
        <div>금일 활동</div>
        <div class="num" id="card-activity">0</div>
      </div>
      <div class="card">
        <div>열린 매칭</div>
        <div class="num" id="card-open">0</div>
      </div>
    </section>

    <section class="grid">
      <div class="panel">
        <h3>최근 7일 가입</h3>
        <canvas id="chart-signup" height="140"></canvas>
      </div>
      <div class="panel">
        <h3>최근 7일 활동</h3>
        <canvas id="chart-activity" height="140"></canvas>
      </div>
      <div class="panel">
        <h3>매칭 요청 상태</h3>
        <canvas id="chart-pie" height="180"></canvas>
      </div>
    </section>

    <section class="panel" style="margin-top:16px">
      <h3>최근 가입 (최대 6명)</h3>
      <table>
        <thead>
          <tr><th>ID</th><th>이름</th><th>전화</th><th>가입일</th></tr>
        </thead>
        <tbody id="recent-tbody">
          <tr><td colspan="4">로딩중…</td></tr>
        </tbody>
      </table>
    </section>
  </div>

  <script>
// 페이지 로드 후 즉시 실행
document.addEventListener('DOMContentLoaded', () => {
  drawJoin7();
  setInterval(drawJoin7, 60_000);
});

// 7일 가입 차트
async function drawJoin7() {
  try {
    // 데이터 요청
    const r = await fetch('/api/stats/joins7d', { credentials: 'include' });
    const j = await r.json();
    if (!j.ok) throw new Error(j.error || 'api fail');

    // 차트 그리기
    const ctx = document.getElementById('chart-signup').getContext('2d');
    // chart.js는 admin.ejs에 CDN으로 이미 포함되어 있어야 함. :contentReference[oaicite:2]{index=2}
    new Chart(ctx, {
      type: 'line',
      data: {
        labels: j.labels,        // ['YYYY-MM-DD', ...]
        datasets: [{
          label: '최근 7일 가입',
          data: j.data,         // [0,2,1,3,0,5,2]
          tension: 0.25,
          fill: false
        }]
      },
      options: {
        responsive: true,
        maintainAspectRatio: false,
        scales: {
          y: { beginAtZero: true, ticks: { precision: 0 } }
        },
        plugins: {
          legend: { display: false }
        }
      }
    });
  } catch (e) {
    console.error('[chart-join7]', e);
  }
}
</script>
  <script src="/static/admin.js"></script>
</body>
</html>
